<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Boat Safety (v1.2)</title>
  <meta name="theme-color" content="#0b3d91" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#121c2f;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#38bdf8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --border:rgba(148,163,184,.22);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --header: rgba(11,18,32,.72);
      --bar: rgba(11,18,32,.80);
      --pillBg: rgba(148,163,184,.08);
    }

    /* Night mode (red/dim) */
    body.night{
      --bg:#05060a;
      --card:#080910;
      --muted:rgba(255,140,140,.75);
      --text:rgba(255,180,180,.92);
      --accent:#ff4d4d;
      --good:#ff6b6b;
      --warn:#ff6b6b;
      --bad:#ff2e2e;
      --border:rgba(255,80,80,.22);
      --shadow:0 12px 30px rgba(0,0,0,.6);
      --header: rgba(5,6,10,.85);
      --bar: rgba(5,6,10,.90);
      --pillBg: rgba(255,80,80,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(56,189,248,.12), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    body.night{
      background: radial-gradient(1200px 800px at 20% -10%, rgba(255,60,60,.10), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(255,60,60,.06), transparent 60%),
                  var(--bg);
    }

    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: var(--header);
      border-bottom:1px solid var(--border);
      padding: 10px 12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      max-width: 980px;
      margin: 0 auto;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      min-width: 0;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(11,61,145,.95));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:800;
    }
    body.night .logo{
      background: linear-gradient(135deg, rgba(255,60,60,.95), rgba(80,0,0,.95));
    }
    .titlewrap{min-width:0}
    .h1{
      font-size:16px;
      font-weight:800;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin:2px 0 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pillrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--border);
      background: var(--pillBg);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{transform: translateY(1px)}
    .pill.primary{border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.12)}
    body.night .pill.primary{border-color: rgba(255,80,80,.45); background: rgba(255,80,80,.12)}

    main{
      max-width: 980px;
      margin: 12px auto 90px;
      padding: 0 12px;
      display:grid;
      gap: 12px;
    }

    /* Compass status banner */
    .banner{
      max-width: 980px;
      margin: 10px auto 0;
      padding: 0 12px;
    }
    .bannerInner{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(148,163,184,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      box-shadow: var(--shadow);
    }
    .bLeft{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(148,163,184,.10);
    }
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}
    body.night .bannerInner{background: rgba(255,80,80,.06)}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .card{
      grid-column: span 12;
      background: rgba(18,28,47,.88);
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    body.night .card{background: rgba(8,9,16,.90)}
    .card h2{
      margin:0 0 8px 0;
      font-size: 14px;
      letter-spacing:.2px;
      color: #dbeafe;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    body.night .card h2{color: rgba(255,160,160,.95)}
    .muted{color:var(--muted); font-size:12px}
    .bigrow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .stat{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
      background: rgba(148,163,184,.06);
      min-height: 76px;
    }
    body.night .stat{background: rgba(255,80,80,.06)}
    .k{font-size:11px; color:var(--muted)}
    .v{font-size:22px; font-weight:850; margin-top:4px}
    .v small{font-size:12px; font-weight:700; color:var(--muted)}
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:1px solid var(--border);
      background: rgba(148,163,184,.08);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 16px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      min-width: 140px;
      text-align:center;
    }
    body.night .btn{background: rgba(255,80,80,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.14)}
    body.night .btn.primary{border-color: rgba(255,80,80,.55); background: rgba(255,80,80,.14)}
    .btn.bad{border-color: rgba(239,68,68,.60); background: rgba(239,68,68,.14)}
    .btn.good{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.12)}
    .btn.warn{border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12)}
    body.night .btn.good, body.night .btn.warn, body.night .btn.bad{
      border-color: rgba(255,80,80,.65);
      background: rgba(255,80,80,.14);
    }
    .btn.small{padding:10px 10px; border-radius:14px; min-width: 120px}

    .panel{
      border:1px dashed rgba(148,163,184,.30);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.10);
    }
    body.night .panel{border-color: rgba(255,80,80,.25)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .kv{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 8px 10px;
      align-items:center;
      font-size: 12px;
    }
    .kv div:nth-child(odd){color:var(--muted)}

    input[type="range"]{width: 220px}
    input[type="text"], input[type="number"], input[type="time"], textarea, select{
      width: 100%;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    body.night input, body.night textarea, body.night select{background: rgba(255,80,80,.06)}
    textarea{min-height: 86px; resize: vertical}
    .formgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 820px){
      .card.span6{grid-column: span 6;}
      .card.span7{grid-column: span 7;}
      .card.span5{grid-column: span 5;}
      .formgrid{grid-template-columns: 1fr 1fr;}
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin: 0 0 6px}
    .help{font-size:12px; color:var(--muted); margin-top:6px}

    .log{
      max-height: 220px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.14);
      font-size: 12px;
    }

    .footerbar{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 20;
      background: var(--bar);
      border-top:1px solid var(--border);
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .footerwrap{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusDot{
      width:10px; height:10px; border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(148,163,184,.10);
      display:inline-block;
      margin-right:8px;
    }
    .statusDot.good{background: var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,.12)}
    .statusDot.warn{background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.12)}
    .statusDot.bad{background: var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.12)}
    body.night .statusDot{box-shadow: 0 0 0 4px rgba(255,80,80,.10)}
    .copyright{
      color: var(--muted);
      font-size: 11px;
    }

    /* Full-screen overlay (Return to MOB + VHF big script) */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 999;
      display: none;
      background: rgba(0,0,0,.88);
      padding: 14px 14px 18px;
    }
    body.night .overlay{background: rgba(0,0,0,.92)}
    .overlay.show{display:block}
    .ovwrap{
      height: 100%;
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .ovtop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .ovtitle{
      font-size: 18px;
      font-weight: 900;
      letter-spacing: .2px;
    }
    .ovsub{
      color: var(--muted);
      font-size: 12px;
      margin-top:2px;
    }
    .ovbtn{
      border:1px solid var(--border);
      background: rgba(148,163,184,.10);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      min-width: 150px;
      text-align:center;
      user-select:none;
    }
    body.night .ovbtn{background: rgba(255,80,80,.10)}
    .ovbtn.bad{border-color: rgba(239,68,68,.65); background: rgba(239,68,68,.14)}
    body.night .ovbtn.bad{border-color: rgba(255,80,80,.70); background: rgba(255,80,80,.16)}
    .ovcard{
      flex: 1;
      border:1px solid var(--border);
      border-radius: 22px;
      background: rgba(18,28,47,.80);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      padding: 14px;
      gap: 12px;
      min-height: 0;
      overflow:auto;
    }
    body.night .ovcard{background: rgba(8,9,16,.86)}
    .hint{
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      margin-top: -2px;
    }

    /* MOB arrow */
    .mobgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      align-items:center;
    }
    @media (min-width: 820px){
      .mobgrid{grid-template-columns: 1.2fr .8fr;}
    }
    .arrowbox{
      border:1px solid var(--border);
      border-radius: 22px;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 280px;
    }
    body.night .arrowbox{background: rgba(255,80,80,.05)}
    .arrowSvg{
      width: min(520px, 90vw);
      height: min(520px, 46vh);
    }
    .mobstats{
      display:grid;
      gap: 10px;
    }
    .mobstat{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: rgba(148,163,184,.06);
    }
    body.night .mobstat{background: rgba(255,80,80,.06)}
    .mobk{font-size:12px; color:var(--muted)}
    .mobv{font-size: 28px; font-weight: 950; margin-top: 4px}
    .mobv small{font-size:12px; font-weight:800; color:var(--muted)}

    /* README panel */
    .readme{
      display:none;
      margin-top:10px;
    }
    .readme.show{display:block}
    .readme .panel{background: rgba(0,0,0,.14)}
    .readme h3{margin:0 0 8px 0; font-size:14px}
    .readme ul{margin:8px 0 0 18px; padding:0}
    .readme li{margin:6px 0; color: var(--text); font-size: 13px}
    .readme .muted{font-size:12px}

    /* VHF helper */
    .vhfModes{display:flex; gap:10px; flex-wrap:wrap}
    .modePill{
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      font-weight: 900;
      background: rgba(148,163,184,.06);
    }
    .modePill.active{border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.12)}
    body.night .modePill.active{border-color: rgba(255,80,80,.55); background: rgba(255,80,80,.12)}
    .scriptBox{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: rgba(0,0,0,.14);
      font-size: 16px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .scriptBox.big{font-size: 20px; line-height:1.35}
    .tiny{font-size:12px; color: var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">â›µ</div>
      <div class="titlewrap">
        <p class="h1" id="t_app">Boat Safety (v1.2)</p>
        <p class="sub" id="t_sub">GPS â€¢ MOB â€¢ Anchor Alarm â€¢ VHF â€¢ Float Plan â€¢ Offline PWA</p>
      </div>
    </div>
    <div class="pillrow">
      <div class="pill" id="btnReadme">README</div>
      <div class="pill" id="btnNight">ðŸŒ™ Night</div>
      <div class="pill primary" id="btnLang">EN</div>
      <div class="pill" id="btnInstall" style="display:none;">Install</div>
    </div>
  </div>
</header>

<!-- Compass status banner -->
<div class="banner">
  <div class="bannerInner">
    <div class="bLeft">
      <div class="dot" id="compDot"></div>
      <div>
        <div style="font-weight:900" id="compTitle">Compass</div>
        <div class="muted" id="compMsg">â€”</div>
      </div>
    </div>
    <div class="row">
      <div class="btn small" id="btnCompass">Enable Compass</div>
    </div>
  </div>

  <div class="readme" id="readmeBox">
    <div class="panel">
      <h3 id="t_readme_title">README</h3>
      <div class="muted" id="t_readme_sub">Safety companion (training / situational awareness). Works offline after first load.</div>
      <ul id="readmeList">
        <li><b>MOB</b>: marks position/time; use <b>Return to MOB</b> for steering guidance.</li>
        <li><b>Anchor alarm</b>: set anchor + radius; alarm triggers if you drift outside.</li>
        <li><b>VHF Helper</b>: shows a clear script for MAYDAY / PAN-PAN / SECURITÃ‰ with your GPS position.</li>
        <li><b>Float Plan</b>: save trip info and a return time; countdown + overdue alarm.</li>
      </ul>
      <div class="muted" style="margin-top:10px" id="t_readme_priv">
        Privacy: settings and logs are stored on this device only. No data is uploaded.
      </div>
      <div class="muted" style="margin-top:6px">
        Â© 2026 Glen Carruthers. All rights reserved.
      </div>
    </div>
  </div>
</div>

<main>
  <div class="grid">

    <!-- Dashboard -->
    <section class="card span7">
      <h2>
        <span id="t_dash">Live Dashboard</span>
        <span class="muted" id="gpsState">â€”</span>
      </h2>

      <div class="bigrow">
        <div class="stat">
          <div class="k" id="t_speed">Speed</div>
          <div class="v"><span id="spd">â€”</span> <small>kn</small></div>
        </div>
        <div class="stat">
          <div class="k" id="t_course">Course (GPS)</div>
          <div class="v"><span id="cog">â€”</span><small>Â°</small></div>
        </div>
        <div class="stat">
          <div class="k" id="t_heading">Heading (Compass)</div>
          <div class="v"><span id="hdg">â€”</span><small>Â°</small></div>
        </div>
        <div class="stat">
          <div class="k" id="t_acc">Accuracy</div>
          <div class="v"><span id="acc">â€”</span> <small>m</small></div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row">
          <div class="btn small primary" id="btnStartGPS">Start GPS</div>
          <div class="btn small" id="btnStopGPS">Stop GPS</div>
        </div>

        <div style="height:10px"></div>

        <div class="kv">
          <div id="t_lat">Latitude</div><div class="mono" id="lat">â€”</div>
          <div id="t_lng">Longitude</div><div class="mono" id="lng">â€”</div>
          <div id="t_time">Last fix</div><div class="mono" id="fixTime">â€”</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px" id="t_note_compass">
        Compass may require permission (iPhone/iPad) and works best outdoors away from metal.
      </div>
    </section>

    <!-- Emergency -->
    <section class="card span5">
      <h2>
        <span id="t_quick">Emergency / Quick Actions</span>
        <span class="muted" id="alarmState">â€”</span>
      </h2>

      <div class="row">
        <div class="btn bad" id="btnMOB">ðŸš¨ MOB (Mark)</div>
        <div class="btn primary" id="btnReturnMOB">â†© Return to MOB</div>
        <div class="btn warn" id="btnClearMOB">Clear MOB</div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="kv">
          <div id="t_mob_point">MOB point</div><div class="mono" id="mobPoint">â€”</div>
          <div id="t_mob_dist">To MOB</div><div class="mono" id="mobDist">â€”</div>
          <div id="t_mob_brg">Bearing</div><div class="mono" id="mobBrg">â€”</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn good" id="btnAnchorSet">âš“ Set Anchor</div>
        <div class="btn warn" id="btnAnchorClear">Clear Anchor</div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="muted" id="t_radius">Anchor radius</div>
          <div class="mono"><span id="radVal">50</span> m</div>
        </div>
        <input type="range" id="rad" min="10" max="200" step="5" value="50" />
        <div style="height:8px"></div>
        <div class="kv">
          <div id="t_anchor_point">Anchor point</div><div class="mono" id="anchorPoint">â€”</div>
          <div id="t_anchor_dist">Distance</div><div class="mono" id="anchorDist">â€”</div>
          <div id="t_anchor_status">Status</div><div class="mono" id="anchorStatus">â€”</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn primary" id="btnVHF">ðŸ“¡ VHF Distress Helper</div>
        <div class="btn" id="btnStopAlarm">Stop Alarm</div>
      </div>
    </section>

    <!-- Float plan -->
    <section class="card span6">
      <h2><span id="t_float">Float Plan + Overdue Timer</span><span class="muted" id="floatStatus">â€”</span></h2>

      <div class="formgrid">
        <div class="field">
          <label id="t_vessel">Vessel name</label>
          <input type="text" id="vesselName" placeholder="e.g., Sea Breeze" />
        </div>
        <div class="field">
          <label id="t_people">People on board</label>
          <input type="text" id="pob" placeholder="e.g., 2 adults, 1 child" />
        </div>
        <div class="field">
          <label id="t_depart">Departure (notes)</label>
          <input type="text" id="depart" placeholder="e.g., Grimsby Marina" />
        </div>
        <div class="field">
          <label id="t_dest">Destination (notes)</label>
          <input type="text" id="dest" placeholder="e.g., Fifty Point" />
        </div>
        <div class="field">
          <label id="t_contact">Shore contact</label>
          <input type="text" id="contact" placeholder="Name + phone/email" />
        </div>
        <div class="field">
          <label id="t_return_time">Return time (today)</label>
          <input type="time" id="returnTime" />
          <div class="help" id="t_return_help">Set the expected return time. Timer alarms if overdue.</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <div class="muted" id="t_countdown">Countdown</div>
            <div style="font-size:26px;font-weight:950" class="mono" id="countdown">â€”</div>
          </div>
          <div class="row">
            <div class="btn small primary" id="btnSaveFloat">Save Plan</div>
            <div class="btn small" id="btnStartTimer">Start Timer</div>
            <div class="btn small warn" id="btnStopTimer">Stop</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <div class="btn small" id="btnCopyFloat">Copy Message</div>
          <div class="btn small warn" id="btnClearFloat">Clear Plan</div>
        </div>
        <div class="tiny" style="margin-top:8px" id="floatMsgHint">
          Tip: Copy Message creates a ready-to-send text you can paste into SMS or email.
        </div>
      </div>
    </section>

    <!-- Settings + Log -->
    <section class="card span6">
      <h2><span id="t_settings">Settings</span><span class="muted">Local only</span></h2>
      <div class="row" style="flex-wrap:wrap">
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setNight" style="accent-color: var(--accent)"/> <span id="t_night">Night mode</span>
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setSound" style="accent-color: var(--accent)"/> <span id="t_sound">Sound</span>
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setVibe" style="accent-color: var(--accent)"/> <span id="t_vibe">Vibration</span>
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setLog" style="accent-color: var(--accent)"/> <span id="t_log">Log events</span>
        </label>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn small" id="btnTestAlarm">Test Alarm</div>
        <div class="btn small" id="btnExport">Export CSV</div>
        <div class="btn small warn" id="btnClearLog">Clear Log</div>
      </div>

      <div style="height:10px"></div>

      <div class="log mono" id="logBox">â€”</div>
      <div class="muted" style="margin-top:8px">
        Â© 2026 Glen Carruthers. All rights reserved.
      </div>
    </section>

  </div>
</main>

<div class="footerbar">
  <div class="footerwrap">
    <div class="muted">
      <span class="statusDot" id="dot"></span>
      <span id="footerStatus">â€”</span>
    </div>
    <div class="copyright" id="copyright">
      Â© <span id="yy"></span> Glen Carruthers. All rights reserved.
    </div>
  </div>
</div>

<!-- Overlay: Return to MOB -->
<div class="overlay" id="mobOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle" id="t_mob_screen">RETURN TO MOB</div>
        <div class="ovsub" id="mobHint">â€”</div>
      </div>
      <div class="row">
        <div class="ovbtn" id="btnCalibrate">ðŸ§­ Calibrate</div>
        <div class="ovbtn bad" id="btnExitMob">âœ• Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="mobgrid">
        <div>
          <div class="arrowbox">
            <svg class="arrowSvg" viewBox="0 0 200 200" role="img" aria-label="Steering arrow">
              <circle cx="100" cy="100" r="86" fill="none" stroke="rgba(148,163,184,.35)" stroke-width="6"></circle>
              <circle cx="100" cy="100" r="70" fill="none" stroke="rgba(148,163,184,.18)" stroke-width="4"></circle>
              <text x="100" y="26" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.85)" font-weight="800">N</text>
              <text x="178" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">E</text>
              <text x="100" y="190" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">S</text>
              <text x="22" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">W</text>

              <g id="arrowGroup" transform="rotate(0 100 100)">
                <polygon points="100,26 82,104 118,104" fill="rgba(56,189,248,.95)"></polygon>
                <polygon points="100,26 92,52 108,52" fill="rgba(239,68,68,.92)"></polygon>
                <rect x="92" y="104" width="16" height="58" rx="8" fill="rgba(56,189,248,.55)"></rect>
              </g>
              <circle cx="100" cy="100" r="6" fill="rgba(56,189,248,.95)"></circle>
            </svg>
          </div>
          <div class="hint" id="t_mob_hint">
            Steer until the arrow points UP. (Uses Compass heading when available, otherwise GPS course.)
          </div>
        </div>

        <div class="mobstats">
          <div class="mobstat">
            <div class="mobk" id="t_to_mob">To MOB</div>
            <div class="mobv"><span id="mobBigDist">â€”</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk" id="t_bearing_to_mob">Bearing to MOB</div>
            <div class="mobv"><span id="mobBigBrg">â€”</span><small>Â°</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk" id="t_your_heading">Your heading</div>
            <div class="mobv"><span id="mobBigHdg">â€”</span><small>Â°</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk" id="t_turn">Turn</div>
            <div class="mobv"><span id="mobTurn">â€”</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk" id="t_speed2">Speed</div>
            <div class="mobv"><span id="mobBigSpd">â€”</span> <small>kn</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk" id="t_accuracy2">Accuracy</div>
            <div class="mobv"><span id="mobBigAcc">â€”</span> <small>m</small></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Overlay: VHF helper -->
<div class="overlay" id="vhfOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle" id="t_vhf_title">VHF Distress Helper</div>
        <div class="ovsub" id="vhfSub">â€”</div>
      </div>
      <div class="row">
        <div class="ovbtn" id="btnVhfBig">A A</div>
        <div class="ovbtn" id="btnCopyVhf">Copy</div>
        <div class="ovbtn bad" id="btnExitVhf">âœ• Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="vhfModes">
        <div class="modePill active" data-mode="MAYDAY" id="mMayday">MAYDAY</div>
        <div class="modePill" data-mode="PANPAN" id="mPanpan">PAN-PAN</div>
        <div class="modePill" data-mode="SECURITE" id="mSecurite">SECURITÃ‰</div>
      </div>

      <div class="help" id="t_vhf_help">
        Read this slowly and clearly. Replace bracketed items with your details.
      </div>

      <div class="scriptBox" id="vhfScript">â€”</div>

      <div class="help tiny" id="vhfNote">
        Note: DSC distress may be available on your radio. This helper is for voice procedure support.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  // -----------------------------
  // i18n strings (lightweight)
  // -----------------------------
  const STR = {
    en: {
      app:"Boat Safety (v1.2)",
      sub:"GPS â€¢ MOB â€¢ Anchor Alarm â€¢ VHF â€¢ Float Plan â€¢ Offline PWA",
      dash:"Live Dashboard",
      speed:"Speed", course:"Course (GPS)", heading:"Heading (Compass)", acc:"Accuracy",
      lat:"Latitude", lng:"Longitude", time:"Last fix",
      note_compass:"Compass may require permission (iPhone/iPad) and works best outdoors away from metal.",
      quick:"Emergency / Quick Actions",
      mob_point:"MOB point", mob_dist:"To MOB", mob_brg:"Bearing",
      radius:"Anchor radius", anchor_point:"Anchor point", anchor_dist:"Distance", anchor_status:"Status",
      float:"Float Plan + Overdue Timer",
      vessel:"Vessel name", people:"People on board", depart:"Departure (notes)", dest:"Destination (notes)",
      contact:"Shore contact", return_time:"Return time (today)", return_help:"Set the expected return time. Timer alarms if overdue.",
      countdown:"Countdown",
      settings:"Settings",
      night:"Night mode", sound:"Sound", vibe:"Vibration", log:"Log events",
      gps_start:"Start GPS", gps_stop:"Stop GPS",
      anchor_ok:"OK", anchor_alarm:"ALARM",
      alarm_on:"Alarm ON", alarm_off:"Alarm OFF",
      footer_ok:"All systems normal", footer_warn:"Attention needed", footer_bad:"ALARM active",
      need_mob:"Mark MOB first (press MOB).",
      need_gps:"Start GPS for live updates.",
      compass_recommend:"Compass recommended for best steering.",
      turn_left:"LEFT", turn_right:"RIGHT", on_course:"ON COURSE",
      mob_screen:"RETURN TO MOB",
      mob_hint:"Steer until the arrow points UP. (Uses Compass heading when available, otherwise GPS course.)",
      calibrate_msg:"To calibrate: move the phone in a figure-8, away from metal, then hold it flat.",
      readme_title:"README",
      readme_sub:"Safety companion (training / situational awareness). Works offline after first load.",
      readme_priv:"Privacy: settings and logs are stored on this device only. No data is uploaded.",
      comp_title:"Compass",
      comp_idle:"Tap Enable Compass to use the phone heading sensor.",
      comp_enabled:"Compass enabled â€” heading updating",
      comp_enabled_wait:"Compass enabled â€” waiting for headingâ€¦",
      comp_denied:"Compass permission denied (or not available)",
      comp_unavailable:"Compass not supported on this device/browser",
      vhf_title:"VHF Distress Helper",
      vhf_help:"Read this slowly and clearly. Replace bracketed items with your details.",
      float_saved:"Plan saved",
      timer_running:"Timer running",
      timer_stopped:"Timer stopped",
      overdue:"OVERDUE",
      copy_ok:"Copied to clipboard",
      copy_fail:"Could not copy (your browser blocked it)."
    },
    fr: {
      app:"SÃ©curitÃ© Nautique (v1.2)",
      sub:"GPS â€¢ MOB â€¢ Alarme dâ€™ancre â€¢ VHF â€¢ Plan de route â€¢ PWA hors ligne",
      dash:"Tableau de bord",
      speed:"Vitesse", course:"Cap (GPS)", heading:"RelÃ¨vement (Boussole)", acc:"PrÃ©cision",
      lat:"Latitude", lng:"Longitude", time:"DerniÃ¨re position",
      note_compass:"La boussole peut demander une permission (iPhone/iPad) et fonctionne mieux dehors, loin du mÃ©tal.",
      quick:"Urgence / Actions rapides",
      mob_point:"Point MOB", mob_dist:"Vers MOB", mob_brg:"RelÃ¨vement",
      radius:"Rayon dâ€™ancre", anchor_point:"Point dâ€™ancre", anchor_dist:"Distance", anchor_status:"Ã‰tat",
      float:"Plan de route + minuterie de retard",
      vessel:"Nom du bateau", people:"Personnes Ã  bord", depart:"DÃ©part (notes)", dest:"Destination (notes)",
      contact:"Contact Ã  terre", return_time:"Heure de retour (aujourdâ€™hui)", return_help:"DÃ©finissez lâ€™heure de retour prÃ©vue. Alarme si en retard.",
      countdown:"Compte Ã  rebours",
      settings:"RÃ©glages",
      night:"Mode nuit", sound:"Son", vibe:"Vibration", log:"Journaliser",
      gps_start:"DÃ©marrer GPS", gps_stop:"ArrÃªter GPS",
      anchor_ok:"OK", anchor_alarm:"ALARME",
      alarm_on:"Alarme ON", alarm_off:"Alarme OFF",
      footer_ok:"Tout est normal", footer_warn:"Attention requise", footer_bad:"ALARME active",
      need_mob:"Marquez dâ€™abord MOB (bouton MOB).",
      need_gps:"DÃ©marrez le GPS pour les mises Ã  jour.",
      compass_recommend:"Boussole recommandÃ©e pour un guidage optimal.",
      turn_left:"GAUCHE", turn_right:"DROITE", on_course:"SUR LE CAP",
      mob_screen:"RETOUR VERS MOB",
      mob_hint:"Barrez jusquâ€™Ã  ce que la flÃ¨che pointe VERS LE HAUT. (Boussole si disponible, sinon cap GPS.)",
      calibrate_msg:"Pour calibrer : mouvement en Â« 8 Â» loin du mÃ©tal, puis tenez le tÃ©lÃ©phone Ã  plat.",
      readme_title:"README",
      readme_sub:"Compagnon de sÃ©curitÃ© (formation / aide). Fonctionne hors ligne aprÃ¨s le premier chargement.",
      readme_priv:"ConfidentialitÃ© : rÃ©glages et journal sur cet appareil seulement. Aucune donnÃ©e envoyÃ©e.",
      comp_title:"Boussole",
      comp_idle:"Touchez Activer boussole pour utiliser le cap du tÃ©lÃ©phone.",
      comp_enabled:"Boussole activÃ©e â€” cap en mise Ã  jour",
      comp_enabled_wait:"Boussole activÃ©e â€” en attente du capâ€¦",
      comp_denied:"Permission boussole refusÃ©e (ou indisponible)",
      comp_unavailable:"Boussole non prise en charge sur cet appareil/navigateur",
      vhf_title:"Assistant VHF",
      vhf_help:"Lisez lentement et clairement. Remplacez les Ã©lÃ©ments entre crochets par vos dÃ©tails.",
      float_saved:"Plan enregistrÃ©",
      timer_running:"Minuterie active",
      timer_stopped:"Minuterie arrÃªtÃ©e",
      overdue:"EN RETARD",
      copy_ok:"CopiÃ©",
      copy_fail:"Impossible de copier (bloquÃ© par le navigateur)."
    }
  };

  // -----------------------------
  // State & storage
  // -----------------------------
  const LS_KEY = "boatSafety_v1_2";
  const state = {
    lang:"en",
    watchId:null,
    lastPos:null,
    cog:null,
    spdKn:null,
    accM:null,
    compassDeg:null,
    mob:null,
    anchor:null,
    radiusM:50,
    alarmActive:false,
    settings:{ night:false, sound:true, vibe:true, log:true },
    log:[],
    // Float plan
    floatPlan:{
      vesselName:"",
      pob:"",
      depart:"",
      dest:"",
      contact:"",
      returnTime:"",     // "HH:MM"
      returnEpoch:null,  // computed when timer starts
      timerRunning:false
    },
    // VHF
    vhfMode:"MAYDAY",
    vhfBig:false
  };

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function toRad(d){ return d*Math.PI/180; }
  function toDeg(r){ return r*180/Math.PI; }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const d = JSON.parse(raw);
      if (!d || typeof d !== "object") return;
      if (d.lang) state.lang = d.lang;
      if (d.radiusM) state.radiusM = clamp(+d.radiusM||50,10,200);
      if (d.settings) state.settings = Object.assign(state.settings, d.settings);
      if (d.mob) state.mob = d.mob;
      if (d.anchor) state.anchor = d.anchor;
      if (Array.isArray(d.log)) state.log = d.log.slice(-500);
      if (d.floatPlan) state.floatPlan = Object.assign(state.floatPlan, d.floatPlan);
      if (d.vhfMode) state.vhfMode = d.vhfMode;
      if (typeof d.vhfBig === "boolean") state.vhfBig = d.vhfBig;
    }catch(_){}
  }
  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      lang: state.lang,
      radiusM: state.radiusM,
      settings: state.settings,
      mob: state.mob,
      anchor: state.anchor,
      log: state.log.slice(-500),
      floatPlan: state.floatPlan,
      vhfMode: state.vhfMode,
      vhfBig: state.vhfBig
    }));
  }

  function t(key){
    return (STR[state.lang] && STR[state.lang][key]) || STR.en[key] || key;
  }

  function logEvent(type, detail){
    if (!state.settings.log) return;
    const iso = new Date().toISOString();
    const pos = state.lastPos ? {lat: state.lastPos.lat, lng: state.lastPos.lng} : null;
    state.log.push({t: iso, type, detail, pos});
    if (state.log.length > 500) state.log.shift();
    save();
    renderLog();
  }

  // -----------------------------
  // Math
  // -----------------------------
  function fmtCoord(n){ return (n==null||!isFinite(n)) ? "â€”" : n.toFixed(6); }
  function fmtDeg(n){ return (n==null||!isFinite(n)) ? "â€”" : Math.round(n).toString(); }
  function fmtKn(n){ return (n==null||!isFinite(n)) ? "â€”" : (Math.round(n*10)/10).toFixed(1); }
  function fmtM(n){
    if (n==null||!isFinite(n)) return "â€”";
    if (n<1000) return `${Math.round(n)} m`;
    return `${(n/1000).toFixed(2)} km`;
  }
  function haversineMeters(a,b){
    const R=6371000;
    const dLat=toRad(b.lat-a.lat);
    const dLon=toRad(b.lng-a.lng);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
    return R*c;
  }
  function bearingDeg(a,b){
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const dLon=toRad(b.lng-a.lng);
    const y=Math.sin(dLon)*Math.cos(lat2);
    const x=Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
    return (toDeg(Math.atan2(y,x))+360)%360;
  }
  function getHeadingSource(){
    if (state.compassDeg != null && isFinite(state.compassDeg)) return {val: state.compassDeg, src:"compass"};
    if (state.cog != null && isFinite(state.cog)) return {val: state.cog, src:"gps"};
    return {val:null, src:"none"};
  }
  function deltaAngle(target, current){
    if (target==null || current==null) return null;
    return (target - current + 540) % 360 - 180;
  }

  // -----------------------------
  // Alarm
  // -----------------------------
  let audioCtx=null, alarmTimer=null;
  function beepOnce(){
    try{
      if (!state.settings.sound) return;
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type="sine"; o.frequency.value=880;
      g.gain.value=0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      const now=audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.25);
      o.stop(now+0.26);
    }catch(_){}
  }
  function vibratePattern(){
    if (!state.settings.vibe) return;
    if (navigator.vibrate) navigator.vibrate([200,120,200,120,350]);
  }
  function startAlarm(reason){
    if (state.alarmActive) return;
    state.alarmActive=true;
    save();
    setFooterStatus("bad");
    $("alarmState").textContent = t("alarm_on");
    logEvent("ALARM", reason || "Alarm triggered");
    beepOnce(); vibratePattern();
    alarmTimer = setInterval(()=>{beepOnce(); vibratePattern();}, 1800);
  }
  function stopAlarm(){
    state.alarmActive=false;
    if (alarmTimer) clearInterval(alarmTimer);
    alarmTimer=null;
    save();
    updateOverallStatus();
    $("alarmState").textContent = t("alarm_off");
  }

  // -----------------------------
  // GPS
  // -----------------------------
  function startGPS(){
    if (!navigator.geolocation){
      $("gpsState").textContent = "GPS unavailable";
      setFooterStatus("warn");
      return;
    }
    if (state.watchId != null) return;

    $("gpsState").textContent = "Waiting for GPSâ€¦";
    setFooterStatus("warn");

    state.watchId = navigator.geolocation.watchPosition(
      (pos)=>{
        const c=pos.coords;
        state.lastPos={lat:c.latitude, lng:c.longitude};
        state.accM=c.accuracy;
        state.spdKn=(c.speed==null||!isFinite(c.speed))?null:(c.speed*1.94384449);
        state.cog=(c.heading==null||!isFinite(c.heading))?null:c.heading;
        renderFix(pos.timestamp);
        updateMOB();
        updateAnchor();
        updateMOBOverlay();
        updateVhfOverlay();
        updateFloatCountdown();
        updateOverallStatus();
      },
      (err)=>{
        $("gpsState").textContent = (err && err.code===1) ? "GPS permission denied" : "GPS unavailable";
        setFooterStatus("warn");
      },
      {enableHighAccuracy:true, maximumAge:1000, timeout:15000}
    );

    $("gpsState").textContent = "GPS running";
    logEvent("GPS","Started");
  }

  function stopGPS(){
    if (state.watchId != null){
      navigator.geolocation.clearWatch(state.watchId);
      state.watchId=null;
      $("gpsState").textContent="GPS stopped";
      logEvent("GPS","Stopped");
      updateOverallStatus();
      updateFloatCountdown();
    }
  }

  function renderFix(ts){
    $("lat").textContent = fmtCoord(state.lastPos?.lat);
    $("lng").textContent = fmtCoord(state.lastPos?.lng);
    $("acc").textContent = (state.accM==null) ? "â€”" : Math.round(state.accM).toString();
    $("spd").textContent = fmtKn(state.spdKn);
    $("cog").textContent = fmtDeg(state.cog);
    $("hdg").textContent = fmtDeg(state.compassDeg);
    $("fixTime").textContent = new Date(ts).toLocaleString();
    $("mobBigSpd").textContent = fmtKn(state.spdKn);
    $("mobBigAcc").textContent = (state.accM==null) ? "â€”" : Math.round(state.accM).toString();
  }

  // -----------------------------
  // Compass with status banner
  // -----------------------------
  let compSeen=false, compWaitTimer=null;

  function setCompBanner(level, msg){
    const dot = $("compDot");
    dot.classList.remove("good","warn","bad");
    if (level) dot.classList.add(level);
    $("compTitle").textContent = t("comp_title");
    $("compMsg").textContent = msg;
  }

  function handleOrientation(ev){
    let heading=null;
    if (typeof ev.webkitCompassHeading === "number" && isFinite(ev.webkitCompassHeading)) heading = ev.webkitCompassHeading;
    else if (typeof ev.alpha === "number" && isFinite(ev.alpha)) heading = (360 - ev.alpha) % 360;

    if (heading != null){
      state.compassDeg = heading;
      $("hdg").textContent = fmtDeg(state.compassDeg);
      compSeen = true;
      setCompBanner("good", t("comp_enabled"));
      updateMOBOverlay();
      save();
    }
  }

  async function enableCompass(){
    compSeen = false;
    setCompBanner("warn", t("comp_enabled_wait"));

    if (!("DeviceOrientationEvent" in window)){
      setCompBanner("warn", t("comp_unavailable"));
      logEvent("COMPASS","Unavailable");
      return;
    }

    try{
      if (typeof DeviceOrientationEvent.requestPermission === "function"){
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") throw new Error("denied");
      }
      window.addEventListener("deviceorientation", handleOrientation, true);
      logEvent("COMPASS","Enabled");

      // if no heading arrives in 3 seconds, show a warning
      if (compWaitTimer) clearTimeout(compWaitTimer);
      compWaitTimer = setTimeout(()=>{
        if (!compSeen){
          setCompBanner("warn", t("comp_enabled_wait"));
        }
      }, 3000);

    }catch(_){
      setCompBanner("warn", t("comp_denied"));
      logEvent("COMPASS","Denied");
    }
  }

  // -----------------------------
  // MOB
  // -----------------------------
  function setMOB(){
    if (!state.lastPos) return;
    state.mob={...state.lastPos, t:Date.now()};
    save();
    renderMOB();
    logEvent("MOB", `${state.mob.lat.toFixed(6)}, ${state.mob.lng.toFixed(6)}`);
  }
  function clearMOB(){
    state.mob=null;
    save();
    renderMOB();
    logEvent("MOB","Cleared");
    hideMOBOverlay();
  }
  function renderMOB(){
    if (!state.mob){
      $("mobPoint").textContent="â€”";
      $("mobDist").textContent="â€”";
      $("mobBrg").textContent="â€”";
      return;
    }
    $("mobPoint").textContent = `${state.mob.lat.toFixed(6)}, ${state.mob.lng.toFixed(6)}`;
    updateMOB();
  }
  function updateMOB(){
    if (!state.mob || !state.lastPos) return;
    const d=haversineMeters(state.lastPos, state.mob);
    const b=bearingDeg(state.lastPos, state.mob);
    $("mobDist").textContent = fmtM(d);
    $("mobBrg").textContent = `${Math.round(b)}Â°`;
  }

  // -----------------------------
  // Anchor alarm
  // -----------------------------
  function setAnchor(){
    if (!state.lastPos) return;
    state.anchor={...state.lastPos, t:Date.now()};
    save();
    renderAnchor();
    logEvent("ANCHOR", `${state.anchor.lat.toFixed(6)}, ${state.anchor.lng.toFixed(6)} (r=${state.radiusM}m)`);
  }
  function clearAnchor(){
    state.anchor=null;
    save();
    renderAnchor();
    stopAlarm();
    logEvent("ANCHOR","Cleared");
  }
  function renderAnchor(){
    if (!state.anchor){
      $("anchorPoint").textContent="â€”";
      $("anchorDist").textContent="â€”";
      $("anchorStatus").textContent="â€”";
      return;
    }
    $("anchorPoint").textContent=`${state.anchor.lat.toFixed(6)}, ${state.anchor.lng.toFixed(6)}`;
    updateAnchor();
  }
  function updateAnchor(){
    if (!state.anchor || !state.lastPos) return;
    const d=haversineMeters(state.lastPos, state.anchor);
    $("anchorDist").textContent = fmtM(d);
    const ok = d <= state.radiusM;
    $("anchorStatus").textContent = ok ? t("anchor_ok") : t("anchor_alarm");
    if (!ok) startAlarm("Anchor radius exceeded");
    if (ok && state.alarmActive) stopAlarm();
  }

  // -----------------------------
  // Return to MOB overlay
  // -----------------------------
  let mobOverlayTimer=null;
  function showMOBOverlay(){
    if (!state.mob){ alert(t("need_mob")); return; }
    $("mobOverlay").classList.add("show");
    $("mobOverlay").setAttribute("aria-hidden","false");
    updateMOBOverlay();
    mobOverlayTimer = mobOverlayTimer || setInterval(updateMOBOverlay, 400);
    requestWakeLock();
  }
  function hideMOBOverlay(){
    $("mobOverlay").classList.remove("show");
    $("mobOverlay").setAttribute("aria-hidden","true");
    if (mobOverlayTimer) clearInterval(mobOverlayTimer);
    mobOverlayTimer=null;
    releaseWakeLock();
  }
  function updateMOBOverlay(){
    const hintBits=[];
    if (!state.mob) hintBits.push(t("need_mob"));
    if (state.watchId==null) hintBits.push(t("need_gps"));
    const hs=getHeadingSource();
    if (hs.src==="gps") hintBits.push(t("compass_recommend"));
    $("mobHint").textContent = hintBits.length ? hintBits.join(" â€¢ ") : "â€”";

    if (!state.mob || !state.lastPos){
      $("mobBigDist").textContent="â€”";
      $("mobBigBrg").textContent="â€”";
      $("mobBigHdg").textContent="â€”";
      $("mobTurn").textContent="â€”";
      return;
    }
    const d=haversineMeters(state.lastPos, state.mob);
    const b=bearingDeg(state.lastPos, state.mob);
    $("mobBigDist").textContent=fmtM(d);
    $("mobBigBrg").textContent=Math.round(b).toString();

    const heading=hs.val;
    $("mobBigHdg").textContent = heading==null ? "â€”" : Math.round(heading).toString();

    const rel = (heading==null) ? 0 : ((b - heading + 360) % 360);
    $("arrowGroup").setAttribute("transform", `rotate(${rel.toFixed(1)} 100 100)`);

    const delta = deltaAngle(b, heading);
    if (delta==null) $("mobTurn").textContent="â€”";
    else{
      const abs=Math.abs(delta);
      if (abs < 8) $("mobTurn").textContent = t("on_course");
      else if (delta < 0) $("mobTurn").textContent = `${t("turn_left")} ${Math.round(abs)}Â°`;
      else $("mobTurn").textContent = `${t("turn_right")} ${Math.round(abs)}Â°`;
    }
  }

  // Wake Lock (best effort)
  let wakeLock=null;
  async function requestWakeLock(){
    try{
      if ("wakeLock" in navigator && !wakeLock) wakeLock = await navigator.wakeLock.request("screen");
    }catch(_){}
  }
  async function releaseWakeLock(){
    try{ if (wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(_){}
  }

  // -----------------------------
  // VHF helper overlay
  // -----------------------------
  function showVhf(){
    $("vhfOverlay").classList.add("show");
    $("vhfOverlay").setAttribute("aria-hidden","false");
    updateVhfOverlay();
    requestWakeLock();
  }
  function hideVhf(){
    $("vhfOverlay").classList.remove("show");
    $("vhfOverlay").setAttribute("aria-hidden","true");
    releaseWakeLock();
  }

  function setMode(mode){
    state.vhfMode = mode;
    save();
    document.querySelectorAll(".modePill").forEach(el=>{
      el.classList.toggle("active", el.dataset.mode===mode);
    });
    updateVhfOverlay();
  }

  function fmtPosLine(){
    if (!state.lastPos) return "[POSITION: unknown]";
    const lat = state.lastPos.lat.toFixed(6);
    const lng = state.lastPos.lng.toFixed(6);
    return `POSITION: ${lat}, ${lng} (WGS84)`;
  }

  function buildVhfScript(){
    const vessel = state.floatPlan.vesselName || "[VESSEL NAME]";
    const pob = state.floatPlan.pob || "[PEOPLE ON BOARD]";
    const contact = state.floatPlan.contact || "[SHORE CONTACT]";
    const posLine = fmtPosLine();
    const timeLine = `TIME: ${new Date().toISOString()}`;
    const distress = "[NATURE OF DISTRESS / ASSISTANCE REQUIRED]";
    const desc = "[DESCRIPTION: type/size/colour, etc.]";

    if (state.vhfMode === "MAYDAY"){
      return [
        "MAYDAY MAYDAY MAYDAY",
        `THIS IS ${vessel}, ${vessel}, ${vessel}`,
        posLine,
        timeLine,
        `WE HAVE ${distress}`,
        `PEOPLE ON BOARD: ${pob}`,
        `OTHER INFO: ${desc}`,
        "REQUEST IMMEDIATE ASSISTANCE",
        "OVER"
      ].join("\n");
    }
    if (state.vhfMode === "PANPAN"){
      return [
        "PAN-PAN PAN-PAN PAN-PAN",
        `ALL STATIONS ALL STATIONS ALL STATIONS`,
        `THIS IS ${vessel}, ${vessel}, ${vessel}`,
        posLine,
        timeLine,
        `WE HAVE ${distress}`,
        `PEOPLE ON BOARD: ${pob}`,
        `SHORE CONTACT: ${contact}`,
        "REQUEST ASSISTANCE / ADVICE",
        "OVER"
      ].join("\n");
    }
    // SECURITE
    return [
      "SECURITÃ‰ SECURITÃ‰ SECURITÃ‰",
      "ALL STATIONS ALL STATIONS ALL STATIONS",
      `THIS IS ${vessel}, ${vessel}, ${vessel}`,
      posLine,
      timeLine,
      "NAVIGATIONAL / WEATHER WARNING:",
      "[HAZARD DETAILS / AREA / RECOMMENDATION]",
      "OUT"
    ].join("\n");
  }

  function updateVhfOverlay(){
    $("t_vhf_title").textContent = t("vhf_title");
    $("t_vhf_help").textContent = t("vhf_help");

    // subtitle shows current position quickly
    $("vhfSub").textContent = state.lastPos ? `${state.lastPos.lat.toFixed(5)}, ${state.lastPos.lng.toFixed(5)}` : "â€”";

    const script = buildVhfScript();
    const box = $("vhfScript");
    box.textContent = script;
    box.classList.toggle("big", !!state.vhfBig);
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      alert(t("copy_ok"));
      return true;
    }catch(_){
      alert(t("copy_fail"));
      return false;
    }
  }

  // -----------------------------
  // Float plan + timer
  // -----------------------------
  let floatTimer = null;

  function applyFloatToUI(){
    $("vesselName").value = state.floatPlan.vesselName || "";
    $("pob").value = state.floatPlan.pob || "";
    $("depart").value = state.floatPlan.depart || "";
    $("dest").value = state.floatPlan.dest || "";
    $("contact").value = state.floatPlan.contact || "";
    $("returnTime").value = state.floatPlan.returnTime || "";
  }

  function readFloatFromUI(){
    state.floatPlan.vesselName = ($("vesselName").value || "").trim();
    state.floatPlan.pob = ($("pob").value || "").trim();
    state.floatPlan.depart = ($("depart").value || "").trim();
    state.floatPlan.dest = ($("dest").value || "").trim();
    state.floatPlan.contact = ($("contact").value || "").trim();
    state.floatPlan.returnTime = ($("returnTime").value || "").trim();
  }

  function computeReturnEpochToday(hhmm){
    if (!hhmm || !/^\d\d:\d\d$/.test(hhmm)) return null;
    const [hh, mm] = hhmm.split(":").map(n=>+n);
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    return d.getTime();
  }

  function startFloatTimer(){
    readFloatFromUI();
    const epoch = computeReturnEpochToday(state.floatPlan.returnTime);
    if (!epoch){
      alert(state.lang==="fr" ? "Veuillez choisir une heure de retour." : "Please choose a return time.");
      return;
    }
    state.floatPlan.returnEpoch = epoch;
    state.floatPlan.timerRunning = true;
    save();
    $("floatStatus").textContent = t("timer_running");
    logEvent("FLOAT", "Timer started");
    updateFloatCountdown(true);
    floatTimer = floatTimer || setInterval(updateFloatCountdown, 1000);
  }

  function stopFloatTimer(){
    state.floatPlan.timerRunning = false;
    save();
    $("floatStatus").textContent = t("timer_stopped");
    logEvent("FLOAT", "Timer stopped");
    if (floatTimer) clearInterval(floatTimer);
    floatTimer = null;
    updateFloatCountdown(true);
  }

  function updateFloatCountdown(force){
    const running = !!state.floatPlan.timerRunning;
    const epoch = state.floatPlan.returnEpoch;

    if (!running || !epoch){
      $("countdown").textContent = "â€”";
      if (force) $("floatStatus").textContent = t("timer_stopped");
      return;
    }

    const now = Date.now();
    let diff = epoch - now; // ms
    const overdue = diff < 0;
    diff = Math.abs(diff);

    const s = Math.floor(diff/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    const text = `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;

    $("countdown").textContent = overdue ? `${t("overdue")} ${text}` : text;
    $("floatStatus").textContent = overdue ? t("overdue") : t("timer_running");

    if (overdue && !state.alarmActive){
      startAlarm("Float plan overdue");
      logEvent("FLOAT", "Overdue alarm");
    }
  }

  function saveFloat(){
    readFloatFromUI();
    save();
    $("floatStatus").textContent = t("float_saved");
    logEvent("FLOAT", "Plan saved");
  }

  function clearFloat(){
    state.floatPlan = {
      vesselName:"", pob:"", depart:"", dest:"", contact:"",
      returnTime:"", returnEpoch:null, timerRunning:false
    };
    save();
    applyFloatToUI();
    stopFloatTimer();
    $("floatStatus").textContent = "â€”";
    logEvent("FLOAT", "Plan cleared");
  }

  function buildFloatMessage(){
    readFloatFromUI();
    const lines = [];
    lines.push("FLOAT PLAN");
    lines.push(`Vessel: ${state.floatPlan.vesselName || "[Vessel]"}`);
    lines.push(`People on board: ${state.floatPlan.pob || "[POB]"}`);
    lines.push(`Departure: ${state.floatPlan.depart || "[Departure]"}`);
    lines.push(`Destination: ${state.floatPlan.dest || "[Destination]"}`);
    lines.push(`Return time: ${state.floatPlan.returnTime || "[HH:MM]"}`);
    lines.push(`Shore contact: ${state.floatPlan.contact || "[Contact]"}`);
    lines.push(state.lastPos ? `Last known position: ${state.lastPos.lat.toFixed(6)}, ${state.lastPos.lng.toFixed(6)}` : "Last known position: [unknown]");
    lines.push(`Generated: ${new Date().toISOString()}`);
    lines.push("Â© 2026 Glen Carruthers. All rights reserved.");
    return lines.join("\n");
  }

  // -----------------------------
  // UI status
  // -----------------------------
  function setFooterStatus(level){
    const dot = $("dot");
    dot.classList.remove("good","warn","bad");
    if (level) dot.classList.add(level);
    if (level==="good") $("footerStatus").textContent = t("footer_ok");
    if (level==="warn") $("footerStatus").textContent = t("footer_warn");
    if (level==="bad") $("footerStatus").textContent = t("footer_bad");
  }
  function updateOverallStatus(){
    if (state.alarmActive) return setFooterStatus("bad");
    if (state.watchId!=null && state.lastPos) return setFooterStatus("good");
    return setFooterStatus("warn");
  }

  // -----------------------------
  // Log UI
  // -----------------------------
  function renderLog(){
    if (!state.log.length){ $("logBox").textContent = "â€”"; return; }
    $("logBox").textContent = state.log.slice().reverse().map(e=>{
      const p = e.pos ? ` @${e.pos.lat.toFixed(5)},${e.pos.lng.toFixed(5)}` : "";
      return `${e.t} | ${e.type} | ${e.detail}${p}`;
    }).join("\n");
  }
  function exportCSV(){
    if (!state.log.length) return;
    const rows=[["time_iso","type","detail","lat","lng"]];
    for (const e of state.log){
      rows.push([e.t, e.type, (e.detail||"").replaceAll('"','""'), e.pos?.lat??"", e.pos?.lng??""]);
    }
    const csv=rows.map(r=>r.map(v=>`"${String(v)}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`boat-safety-log-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // -----------------------------
  // Night mode
  // -----------------------------
  function setNight(on){
    state.settings.night = !!on;
    document.body.classList.toggle("night", state.settings.night);
    const meta=document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute("content", state.settings.night ? "#05060a" : "#0b3d91");
    save();
  }

  // -----------------------------
  // README
  // -----------------------------
  function toggleReadme(){
    $("readmeBox").classList.toggle("show");
  }

  // -----------------------------
  // Init UI labels
  // -----------------------------
  function applyLang(){
    document.documentElement.lang = state.lang;
    $("t_app").textContent = t("app");
    $("t_sub").textContent = t("sub");
    $("t_dash").textContent = t("dash");
    $("t_speed").textContent = t("speed");
    $("t_course").textContent = t("course");
    $("t_heading").textContent = t("heading");
    $("t_acc").textContent = t("acc");
    $("t_lat").textContent = t("lat");
    $("t_lng").textContent = t("lng");
    $("t_time").textContent = t("time");
    $("t_note_compass").textContent = t("note_compass");
    $("t_quick").textContent = t("quick");
    $("t_mob_point").textContent = t("mob_point");
    $("t_mob_dist").textContent = t("mob_dist");
    $("t_mob_brg").textContent = t("mob_brg");
    $("t_radius").textContent = t("radius");
    $("t_anchor_point").textContent = t("anchor_point");
    $("t_anchor_dist").textContent = t("anchor_dist");
    $("t_anchor_status").textContent = t("anchor_status");
    $("t_float").textContent = t("float");
    $("t_vessel").textContent = t("vessel");
    $("t_people").textContent = t("people");
    $("t_depart").textContent = t("depart");
    $("t_dest").textContent = t("dest");
    $("t_contact").textContent = t("contact");
    $("t_return_time").textContent = t("return_time");
    $("t_return_help").textContent = t("return_help");
    $("t_countdown").textContent = t("countdown");
    $("t_settings").textContent = t("settings");
    $("t_night").textContent = t("night");
    $("t_sound").textContent = t("sound");
    $("t_vibe").textContent = t("vibe");
    $("t_log").textContent = t("log");
    $("t_readme_title").textContent = t("readme_title");
    $("t_readme_sub").textContent = t("readme_sub");
    $("t_readme_priv").textContent = t("readme_priv");
    $("compTitle").textContent = t("comp_title");
    $("t_vhf_title").textContent = t("vhf_title");
    $("t_vhf_help").textContent = t("vhf_help");
    $("t_mob_screen").textContent = t("mob_screen");
    $("t_mob_hint").textContent = t("mob_hint");

    $("btnStartGPS").textContent = t("gps_start");
    $("btnStopGPS").textContent = t("gps_stop");

    $("btnLang").textContent = state.lang.toUpperCase();
    $("yy").textContent = new Date().getFullYear();
  }

  // -----------------------------
  // Wire events
  // -----------------------------
  function wire(){
    $("btnStartGPS").addEventListener("click", startGPS);
    $("btnStopGPS").addEventListener("click", stopGPS);

    $("btnCompass").addEventListener("click", enableCompass);

    $("btnNight").addEventListener("click", ()=>{ $("setNight").checked = !$("setNight").checked; setNight($("setNight").checked); });
    $("setNight").addEventListener("change", (e)=> setNight(!!e.target.checked));

    $("btnLang").addEventListener("click", ()=>{
      state.lang = (state.lang==="en") ? "fr" : "en";
      save(); applyLang(); updateVhfOverlay(); updateMOBOverlay();
      setCompBanner("warn", $("compMsg").textContent); // keep current msg
    });

    $("btnReadme").addEventListener("click", toggleReadme);

    $("btnMOB").addEventListener("click", ()=>{
      if (!state.lastPos) return;
      setMOB();
      beepOnce(); if (navigator.vibrate) navigator.vibrate([120,80,120]);
    });
    $("btnClearMOB").addEventListener("click", clearMOB);
    $("btnReturnMOB").addEventListener("click", showMOBOverlay);
    $("btnExitMob").addEventListener("click", hideMOBOverlay);
    $("mobOverlay").addEventListener("click", (e)=>{ if (e.target && e.target.id==="mobOverlay") hideMOBOverlay(); });

    $("btnCalibrate").addEventListener("click", ()=> alert(t("calibrate_msg")));

    $("btnAnchorSet").addEventListener("click", ()=>{ if (state.lastPos) setAnchor(); });
    $("btnAnchorClear").addEventListener("click", clearAnchor);

    $("rad").addEventListener("input", (e)=>{
      state.radiusM = clamp(+e.target.value,10,200);
      $("radVal").textContent = state.radiusM;
      save();
      if (state.anchor && state.lastPos) updateAnchor();
    });

    $("btnStopAlarm").addEventListener("click", stopAlarm);
    $("btnTestAlarm").addEventListener("click", ()=>{ beepOnce(); vibratePattern(); logEvent("TEST","Alarm test"); });

    $("setSound").addEventListener("change",(e)=>{ state.settings.sound=!!e.target.checked; save(); });
    $("setVibe").addEventListener("change",(e)=>{ state.settings.vibe=!!e.target.checked; save(); });
    $("setLog").addEventListener("change",(e)=>{ state.settings.log=!!e.target.checked; save(); renderLog(); });

    $("btnExport").addEventListener("click", exportCSV);
    $("btnClearLog").addEventListener("click", ()=>{ state.log=[]; save(); renderLog(); });

    // VHF overlay
    $("btnVHF").addEventListener("click", showVhf);
    $("btnExitVhf").addEventListener("click", hideVhf);
    $("vhfOverlay").addEventListener("click",(e)=>{ if (e.target && e.target.id==="vhfOverlay") hideVhf(); });

    document.querySelectorAll(".modePill").forEach(el=>{
      el.addEventListener("click", ()=> setMode(el.dataset.mode));
    });
    $("btnVhfBig").addEventListener("click", ()=>{
      state.vhfBig = !state.vhfBig;
      save();
      updateVhfOverlay();
    });
    $("btnCopyVhf").addEventListener("click", ()=> copyText(buildVhfScript()));

    // Float plan
    $("btnSaveFloat").addEventListener("click", saveFloat);
    $("btnStartTimer").addEventListener("click", startFloatTimer);
    $("btnStopTimer").addEventListener("click", stopFloatTimer);
    $("btnClearFloat").addEventListener("click", clearFloat);
    $("btnCopyFloat").addEventListener("click", ()=> copyText(buildFloatMessage()));

    // Esc closes overlays
    window.addEventListener("keydown",(e)=>{
      if (e.key==="Escape"){ hideMOBOverlay(); hideVhf(); }
    });
  }

  // -----------------------------
  // Init
  // -----------------------------
  load();

  // Apply stored settings
  document.body.classList.toggle("night", !!state.settings.night);
  $("setNight").checked = !!state.settings.night;
  $("setSound").checked = !!state.settings.sound;
  $("setVibe").checked = !!state.settings.vibe;
  $("setLog").checked = !!state.settings.log;

  $("rad").value = state.radiusM;
  $("radVal").textContent = state.radiusM;

  applyFloatToUI();
  renderLog();
  renderMOB();
  renderAnchor();

  applyLang();
  $("alarmState").textContent = t("alarm_off");
  $("gpsState").textContent = "GPS stopped";

  setCompBanner("warn", t("comp_idle"));

  // Restore timer if it was running
  if (state.floatPlan.timerRunning && state.floatPlan.returnEpoch){
    $("floatStatus").textContent = t("timer_running");
    floatTimer = setInterval(updateFloatCountdown, 1000);
    updateFloatCountdown(true);
  } else {
    $("floatStatus").textContent = "â€”";
  }

  // Restore VHF mode selection UI
  document.querySelectorAll(".modePill").forEach(el=>{
    el.classList.toggle("active", el.dataset.mode === state.vhfMode);
  });

  // Wire events
  wire();

  // Service worker
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }

})();
</script>
</body>
</html>