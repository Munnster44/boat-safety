<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Boat Safety (v1.4a)</title>
  <meta name="theme-color" content="#0b3d91" />
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#121c2f;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#38bdf8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --border:rgba(148,163,184,.22);
      --shadow:0 12px 30px rgba(0,0,0,.35);
      --header: rgba(11,18,32,.72);
      --bar: rgba(11,18,32,.80);
      --pillBg: rgba(148,163,184,.08);
    }

    /* Night mode (red/dim) */
    body.night{
      --bg:#05060a;
      --card:#080910;
      --muted:rgba(255,140,140,.75);
      --text:rgba(255,180,180,.92);
      --accent:#ff4d4d;
      --good:#ff6b6b;
      --warn:#ff6b6b;
      --bad:#ff2e2e;
      --border:rgba(255,80,80,.22);
      --shadow:0 12px 30px rgba(0,0,0,.6);
      --header: rgba(5,6,10,.85);
      --bar: rgba(5,6,10,.90);
      --pillBg: rgba(255,80,80,.08);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(56,189,248,.12), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    body.night{
      background: radial-gradient(1200px 800px at 20% -10%, rgba(255,60,60,.10), transparent 60%),
                  radial-gradient(1000px 700px at 90% 10%, rgba(255,60,60,.06), transparent 60%),
                  var(--bg);
    }

    header{
      position: sticky;
      top:0;
      z-index:10;
      backdrop-filter: blur(10px);
      background: var(--header);
      border-bottom:1px solid var(--border);
      padding: 10px 12px;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      max-width: 980px;
      margin: 0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; min-width:0;}
    .logo{
      width:38px;height:38px;border-radius:12px;
      background: linear-gradient(135deg, rgba(56,189,248,.95), rgba(11,61,145,.95));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      font-weight:800;
    }
    body.night .logo{
      background: linear-gradient(135deg, rgba(255,60,60,.95), rgba(80,0,0,.95));
    }
    .titlewrap{min-width:0}
    .h1{
      font-size:16px;
      font-weight:800;
      line-height:1.1;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      margin:2px 0 0 0;
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .pillrow{display:flex; gap:8px; align-items:center; flex-wrap:wrap; justify-content:flex-end}
    .pill{
      border:1px solid var(--border);
      background: var(--pillBg);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
      user-select:none;
    }
    .pill:active{transform: translateY(1px)}
    .pill.primary{border-color: rgba(56,189,248,.45); background: rgba(56,189,248,.12)}
    body.night .pill.primary{border-color: rgba(255,80,80,.45); background: rgba(255,80,80,.12)}

    main{
      max-width: 980px;
      margin: 12px auto 90px;
      padding: 0 12px;
      display:grid;
      gap: 12px;
    }

    /* Compass status banner */
    .banner{
      max-width: 980px;
      margin: 10px auto 0;
      padding: 0 12px;
    }
    .bannerInner{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(148,163,184,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      box-shadow: var(--shadow);
    }
    body.night .bannerInner{background: rgba(255,80,80,.06)}
    .bLeft{display:flex; align-items:center; gap:10px}
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(148,163,184,.10);
    }
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}

    .grid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .card{
      grid-column: span 12;
      background: rgba(18,28,47,.88);
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    body.night .card{background: rgba(8,9,16,.90)}
    .card h2{
      margin:0 0 8px 0;
      font-size: 14px;
      letter-spacing:.2px;
      color: #dbeafe;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    body.night .card h2{color: rgba(255,160,160,.95)}
    .muted{color:var(--muted); font-size:12px}
    .bigrow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .stat{
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
      background: rgba(148,163,184,.06);
      min-height: 76px;
    }
    body.night .stat{background: rgba(255,80,80,.06)}
    .k{font-size:11px; color:var(--muted)}
    .v{font-size:22px; font-weight:850; margin-top:4px}
    .v small{font-size:12px; font-weight:700; color:var(--muted)}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .btn{
      border:1px solid var(--border);
      background: rgba(148,163,184,.08);
      color: var(--text);
      padding: 12px 12px;
      border-radius: 16px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      min-width: 140px;
      text-align:center;
    }
    body.night .btn{background: rgba(255,80,80,.08)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.14)}
    body.night .btn.primary{border-color: rgba(255,80,80,.55); background: rgba(255,80,80,.14)}
    .btn.bad{border-color: rgba(239,68,68,.60); background: rgba(239,68,68,.14)}
    .btn.good{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.12)}
    .btn.warn{border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12)}
    body.night .btn.good, body.night .btn.warn, body.night .btn.bad{
      border-color: rgba(255,80,80,.65);
      background: rgba(255,80,80,.14);
    }
    .btn.small{padding:10px 10px; border-radius:14px; min-width: 120px}

    .panel{
      border:1px dashed rgba(148,163,184,.30);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.10);
    }
    body.night .panel{border-color: rgba(255,80,80,.25)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .kv{
      display:grid;
      grid-template-columns: 130px 1fr;
      gap: 8px 10px;
      align-items:center;
      font-size: 12px;
    }
    .kv div:nth-child(odd){color:var(--muted)}

    input[type="range"]{width: 220px}
    input[type="text"], input[type="time"], textarea, select{
      width: 100%;
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline: none;
    }
    body.night input, body.night textarea, body.night select{background: rgba(255,80,80,.06)}
    textarea{min-height: 86px; resize: vertical}
    .formgrid{display:grid; grid-template-columns: 1fr; gap: 10px;}
    @media (min-width: 820px){
      .card.span6{grid-column: span 6;}
      .card.span7{grid-column: span 7;}
      .card.span5{grid-column: span 5;}
      .formgrid{grid-template-columns: 1fr 1fr;}
    }
    .field label{display:block; font-size:12px; color:var(--muted); margin: 0 0 6px}

    .log{
      max-height: 220px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.14);
      font-size: 12px;
    }

    .footerbar{
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      z-index: 20;
      background: var(--bar);
      border-top:1px solid var(--border);
      padding: 10px 12px;
      backdrop-filter: blur(10px);
    }
    .footerwrap{
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .statusDot{
      width:10px; height:10px; border-radius: 50%;
      background: var(--muted);
      box-shadow: 0 0 0 4px rgba(148,163,184,.10);
      display:inline-block;
      margin-right:8px;
    }
    .statusDot.good{background: var(--good); box-shadow: 0 0 0 4px rgba(34,197,94,.12)}
    .statusDot.warn{background: var(--warn); box-shadow: 0 0 0 4px rgba(245,158,11,.12)}
    .statusDot.bad{background: var(--bad); box-shadow: 0 0 0 4px rgba(239,68,68,.12)}
    body.night .statusDot{box-shadow: 0 0 0 4px rgba(255,80,80,.10)}
    .copyright{color: var(--muted); font-size: 11px;}

    /* Overlays */
    .overlay{
      position: fixed;
      inset: 0;
      z-index: 999;
      display: none;
      background: rgba(0,0,0,.88);
      padding: 14px 14px 18px;
    }
    body.night .overlay{background: rgba(0,0,0,.92)}
    .overlay.show{display:block}
    .ovwrap{
      height: 100%;
      max-width: 980px;
      margin: 0 auto;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .ovtop{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      flex-wrap:wrap;
    }
    .ovtitle{font-size: 18px; font-weight: 900; letter-spacing: .2px;}
    .ovsub{color: var(--muted); font-size: 12px; margin-top:2px;}
    .ovbtn{
      border:1px solid var(--border);
      background: rgba(148,163,184,.10);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 900;
      min-width: 150px;
      text-align:center;
      user-select:none;
    }
    body.night .ovbtn{background: rgba(255,80,80,.10)}
    .ovbtn.bad{border-color: rgba(239,68,68,.65); background: rgba(239,68,68,.14)}
    body.night .ovbtn.bad{border-color: rgba(255,80,80,.70); background: rgba(255,80,80,.16)}
    .ovcard{
      flex: 1;
      border:1px solid var(--border);
      border-radius: 22px;
      background: rgba(18,28,47,.80);
      box-shadow: var(--shadow);
      display:flex;
      flex-direction:column;
      padding: 14px;
      gap: 12px;
      min-height: 0;
      overflow:auto;
    }
    body.night .ovcard{background: rgba(8,9,16,.86)}
    .hint{color: var(--muted); font-size: 12px; text-align:center; margin-top: -2px;}

    /* MOB arrow bits */
    .mobgrid{display:grid; grid-template-columns: 1fr; gap: 12px; align-items:center;}
    @media (min-width: 820px){ .mobgrid{grid-template-columns: 1.2fr .8fr;} }
    .arrowbox{
      border:1px solid var(--border);
      border-radius: 22px;
      background: rgba(0,0,0,.12);
      display:flex;
      align-items:center;
      justify-content:center;
      min-height: 280px;
    }
    body.night .arrowbox{background: rgba(255,80,80,.05)}
    .arrowSvg{width: min(520px, 90vw); height: min(520px, 46vh);}
    .mobstats{display:grid; gap: 10px;}
    .mobstat{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: rgba(148,163,184,.06);
    }
    body.night .mobstat{background: rgba(255,80,80,.06)}
    .mobk{font-size:12px; color:var(--muted)}
    .mobv{font-size: 28px; font-weight: 950; margin-top: 4px}
    .mobv small{font-size:12px; font-weight:800; color:var(--muted)}

    /* README */
    .readme{display:none; margin-top:10px;}
    .readme.show{display:block}
    .readme .panel{background: rgba(0,0,0,.14)}
    .readme h3{margin:0 0 8px 0; font-size:14px}
    .readme ul{margin:8px 0 0 18px; padding:0}
    .readme li{margin:6px 0; color: var(--text); font-size: 13px}

    /* VHF */
    .vhfModes{display:flex; gap:10px; flex-wrap:wrap}
    .modePill{
      border:1px solid var(--border);
      border-radius: 999px;
      padding: 8px 10px;
      cursor:pointer;
      user-select:none;
      font-size: 12px;
      font-weight: 900;
      background: rgba(148,163,184,.06);
    }
    .modePill.active{border-color: rgba(56,189,248,.55); background: rgba(56,189,248,.12)}
    body.night .modePill.active{border-color: rgba(255,80,80,.55); background: rgba(255,80,80,.12)}
    .scriptBox{
      border:1px solid var(--border);
      border-radius: 18px;
      padding: 12px;
      background: rgba(0,0,0,.14);
      font-size: 16px;
      line-height: 1.35;
      white-space: pre-wrap;
    }
    .scriptBox.big{font-size: 20px; line-height:1.35}

    /* Fog Mode */
    .fogScreen{
      flex:1;
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap: 18px;
      padding: 10px;
    }
    .fogRow{
      border:1px solid var(--border);
      border-radius: 22px;
      background: rgba(0,0,0,.16);
      padding: 18px 16px;
    }
    body.night .fogRow{background: rgba(255,80,80,.06)}
    .fogLabel{color: var(--muted); font-size: 14px; font-weight:800; letter-spacing:.2px;}
    .fogValue{font-size: 56px; font-weight: 950; margin-top: 6px;}
    .fogValue small{font-size: 18px; color: var(--muted); font-weight: 800;}
    @media (min-width: 820px){
      .fogValue{font-size: 70px;}
    }

    /* Emergency light full-screen panel */
    .lightPad{
      flex:1;
      border-radius: 22px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.20);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .lightCanvas{
      flex:1;
      background:#000;
    }
    .lightControls{
      padding: 12px;
      border-top:1px solid var(--border);
      background: rgba(18,28,47,.85);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
    }
    body.night .lightControls{background: rgba(8,9,16,.90)}
    .tiny{font-size:12px; color: var(--muted)}
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo">‚õµ</div>
      <div class="titlewrap">
        <p class="h1" id="t_app">Boat Safety (v1.4)</p>
        <p class="sub" id="t_sub">GPS ‚Ä¢ MOB ‚Ä¢ Anchor Alarm ‚Ä¢ Drift Advisor ‚Ä¢ VHF ‚Ä¢ Float Plan ‚Ä¢ Fog ‚Ä¢ Light ‚Ä¢ Waypoints ‚Ä¢ Offline PWA</p>
      </div>
    </div>
    <div class="pillrow">
      <div class="pill" id="btnReadme">README</div>
      <div class="pill" id="btnNight">üåô Night</div>
      <div class="pill primary" id="btnLang">EN</div>
      <div class="pill" id="btnInstall" style="display:none;">Install</div>
    </div>
  </div>
</header>

<div class="banner">
  <div class="bannerInner">
    <div class="bLeft">
      <div class="dot" id="compDot"></div>
      <div>
        <div style="font-weight:900" id="compTitle">Compass</div>
        <div class="muted" id="compMsg">‚Äî</div>
      </div>
    </div>
    <div class="row">
      <div class="btn small" id="btnCompass">Enable Compass</div>
      <div class="btn small primary" id="btnFog">üå´ Fog Mode</div>
      <div class="btn small" id="btnLight">üî¶ Emergency Light</div>
    </div>
  </div>

  <div class="readme" id="readmeBox">
    <div class="panel">
      <h3>README</h3>
      <div class="muted">Safety companion (training / situational awareness). Works offline after first load.</div>
      <ul>
        <li><b>MOB</b>: marks position/time; <b>Return to MOB</b> gives steering arrow guidance.</li>
        <li><b>Anchor alarm</b>: set anchor + radius; alarm triggers if you drift outside.</li>
        <li><b>Drift Advisor</b>: compares GPS Course vs Compass Heading and suggests correction.</li>
        <li><b>VHF Helper</b>: MAYDAY / PAN-PAN / SECURIT√â script with your GPS position.</li>
        <li><b>Float Plan</b>: save trip info and return time; countdown + overdue alarm.</li>
        <li><b>Fog Mode</b>: big digits screen (speed/course/heading/drift/accuracy).</li>
        <li><b>Emergency Light</b>: steady white/red + strobe + SOS pattern (screen-based).</li>
        <li><b>Waypoints</b>: mark hazards/safe harbor; shows bearing + distance; export CSV.</li>
      </ul>
      <div class="muted" style="margin-top:10px">
        Privacy: settings and logs are stored on this device only. No data is uploaded.
      </div>
      <div class="muted" style="margin-top:6px">
        ¬© 2026 Glen Carruthers. All rights reserved.
      </div>
    </div>
  </div>
</div>

<main>
  <div class="grid">

    <!-- Dashboard -->
    <section class="card span7">
      <h2>
        <span>Live Dashboard</span>
        <span class="muted" id="gpsState">‚Äî</span>
      </h2>

      <div class="bigrow">
        <div class="stat">
          <div class="k">Speed</div>
          <div class="v"><span id="spd">‚Äî</span> <small>kn</small></div>
        </div>
        <div class="stat">
          <div class="k">Course (GPS)</div>
          <div class="v"><span id="cog">‚Äî</span><small>¬∞</small></div>
        </div>
        <div class="stat">
          <div class="k">Heading (Compass)</div>
          <div class="v"><span id="hdg">‚Äî</span><small>¬∞</small></div>
        </div>
        <div class="stat">
          <div class="k">Accuracy</div>
          <div class="v"><span id="acc">‚Äî</span> <small>m</small></div>
        </div>
      </div>

      <!-- NEW: Drift Advisor panel -->
      <div style="height:10px"></div>
      <div class="panel">
        <div class="kv">
          <div>Drift (set)</div><div class="mono" id="driftVal">‚Äî</div>
          <div>Advisor</div><div class="mono" id="driftRec">‚Äî</div>
        </div>
        <div class="muted" style="margin-top:8px" id="driftNote">
          Uses GPS Course vs Compass Heading. At low speed, GPS course can be jumpy.
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row">
          <div class="btn small primary" id="btnStartGPS">Start GPS</div>
          <div class="btn small" id="btnStopGPS">Stop GPS</div>
        </div>
        <div style="height:10px"></div>
        <div class="kv">
          <div>Latitude</div><div class="mono" id="lat">‚Äî</div>
          <div>Longitude</div><div class="mono" id="lng">‚Äî</div>
          <div>Last fix</div><div class="mono" id="fixTime">‚Äî</div>
        </div>
      </div>
      <div class="muted" style="margin-top:8px">
        Compass may require permission (iPhone/iPad) and works best outdoors away from metal.
      </div>
    </section>

    <!-- Emergency -->
    <section class="card span5">
      <h2>
        <span>Emergency / Quick Actions</span>
        <span class="muted" id="alarmState">‚Äî</span>
      </h2>

      <div class="row">
        <div class="btn bad" id="btnMOB">üö® MOB (Mark)</div>
        <div class="btn primary" id="btnReturnMOB">‚Ü© Return to MOB</div>
        <div class="btn warn" id="btnClearMOB">Clear MOB</div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="kv">
          <div>MOB point</div><div class="mono" id="mobPoint">‚Äî</div>
          <div>To MOB</div><div class="mono" id="mobDist">‚Äî</div>
          <div>Bearing</div><div class="mono" id="mobBrg">‚Äî</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn good" id="btnAnchorSet">‚öì Set Anchor</div>
        <div class="btn warn" id="btnAnchorClear">Clear Anchor</div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="muted">Anchor radius</div>
          <div class="mono"><span id="radVal">50</span> m</div>
        </div>
        <input type="range" id="rad" min="10" max="200" step="5" value="50" />
        <div style="height:8px"></div>
        <div class="kv">
          <div>Anchor point</div><div class="mono" id="anchorPoint">‚Äî</div>
          <div>Distance</div><div class="mono" id="anchorDist">‚Äî</div>
          <div>Status</div><div class="mono" id="anchorStatus">‚Äî</div>
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn primary" id="btnVHF">üì° VHF Distress Helper</div>
        <div class="btn" id="btnStopAlarm">Stop Alarm</div>
      </div>
    </section>

    <!-- Float plan -->
    <section class="card span6">
      <h2><span>Float Plan + Overdue Timer</span><span class="muted" id="floatStatus">‚Äî</span></h2>

      <div class="formgrid">
        <div class="field">
          <label>Vessel name</label>
          <input type="text" id="vesselName" placeholder="e.g., Sea Breeze" />
        </div>
        <div class="field">
          <label>People on board</label>
          <input type="text" id="pob" placeholder="e.g., 2 adults, 1 child" />
        </div>
        <div class="field">
          <label>Departure (notes)</label>
          <input type="text" id="depart" placeholder="e.g., Grimsby Marina" />
        </div>
        <div class="field">
          <label>Destination (notes)</label>
          <input type="text" id="dest" placeholder="e.g., Fifty Point" />
        </div>
        <div class="field">
          <label>Shore contact</label>
          <input type="text" id="contact" placeholder="Name + phone/email" />
        </div>
        <div class="field">
          <label>Return time (today)</label>
          <input type="time" id="returnTime" />
        </div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div>
            <div class="muted">Countdown</div>
            <div style="font-size:26px;font-weight:950" class="mono" id="countdown">‚Äî</div>
          </div>
          <div class="row">
            <div class="btn small primary" id="btnSaveFloat">Save Plan</div>
            <div class="btn small" id="btnStartTimer">Start Timer</div>
            <div class="btn small warn" id="btnStopTimer">Stop</div>
          </div>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <div class="btn small" id="btnCopyFloat">Copy Message</div>
          <div class="btn small warn" id="btnClearFloat">Clear Plan</div>
        </div>
        <div class="tiny" style="margin-top:8px">
          Tip: Copy Message creates a ready-to-send text you can paste into SMS or email.
        </div>
      </div>
    </section>

    <!-- Waypoints -->
    <section class="card span6">
      <h2><span>Waypoints</span><span class="muted" id="wpCount">0</span></h2>

      <div class="row">
        <div class="btn warn" id="btnMarkHazard">‚ö†Ô∏è Mark Hazard</div>
        <div class="btn good" id="btnMarkHarbor">üõü Mark Safe Harbor</div>
        <div class="btn" id="btnMarkWP">üìç Mark Waypoint</div>
      </div>

      <div style="height:10px"></div>

      <div class="panel">
        <div class="field">
          <label>Selected waypoint</label>
          <select id="wpSelect"></select>
        </div>
        <div style="height:10px"></div>
        <div class="kv">
          <div>Type</div><div class="mono" id="wpType">‚Äî</div>
          <div>Coords</div><div class="mono" id="wpCoords">‚Äî</div>
          <div>To WP</div><div class="mono" id="wpDist">‚Äî</div>
          <div>Bearing</div><div class="mono" id="wpBrg">‚Äî</div>
        </div>
        <div style="height:10px"></div>
        <div class="field">
          <label>Notes</label>
          <textarea id="wpNotes" placeholder="Optional notes‚Ä¶"></textarea>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="btn small primary" id="btnSaveWpNotes">Save Notes</div>
          <div class="btn small" id="btnReturnWP">‚û§ Return to WP</div>
          <div class="btn small warn" id="btnDeleteWP">Delete</div>
        </div>
        <div class="row" style="margin-top:10px">
          <div class="btn small" id="btnExportWP">Export Waypoints CSV</div>
        </div>
      </div>
    </section>

    <!-- Settings + Log -->
    <section class="card span6">
      <h2><span>Settings</span><span class="muted">Local only</span></h2>
      <div class="row" style="flex-wrap:wrap">
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setNight" style="accent-color: var(--accent)"/> Night mode
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setSound" style="accent-color: var(--accent)"/> Sound
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setVibe" style="accent-color: var(--accent)"/> Vibration
        </label>
        <label class="pill" style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="setLog" style="accent-color: var(--accent)"/> Log events
        </label>
      </div>

      <div style="height:10px"></div>

      <div class="row">
        <div class="btn small" id="btnTestAlarm">Test Alarm</div>
        <div class="btn small" id="btnExport">Export Log CSV</div>
        <div class="btn small warn" id="btnClearLog">Clear Log</div>
      </div>

      <div style="height:10px"></div>

      <div class="log mono" id="logBox">‚Äî</div>
      <div class="muted" style="margin-top:8px">
        ¬© 2026 Glen Carruthers. All rights reserved.
      </div>
    </section>

  </div>
</main>

<div class="footerbar">
  <div class="footerwrap">
    <div class="muted">
      <span class="statusDot" id="dot"></span>
      <span id="footerStatus">‚Äî</span>
    </div>
    <div class="copyright">
      ¬© <span id="yy"></span> Glen Carruthers. All rights reserved.
    </div>
  </div>
</div>

<!-- Overlay: Return to MOB -->
<div class="overlay" id="mobOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle">RETURN TO MOB</div>
        <div class="ovsub" id="mobHint">‚Äî</div>
      </div>
      <div class="row">
        <div class="ovbtn" id="btnCalibrate">üß≠ Calibrate</div>
        <div class="ovbtn bad" id="btnExitMob">‚úï Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="mobgrid">
        <div>
          <div class="arrowbox">
            <svg class="arrowSvg" viewBox="0 0 200 200" role="img" aria-label="Steering arrow">
              <circle cx="100" cy="100" r="86" fill="none" stroke="rgba(148,163,184,.35)" stroke-width="6"></circle>
              <circle cx="100" cy="100" r="70" fill="none" stroke="rgba(148,163,184,.18)" stroke-width="4"></circle>
              <text x="100" y="26" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.85)" font-weight="800">N</text>
              <text x="178" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">E</text>
              <text x="100" y="190" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">S</text>
              <text x="22" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">W</text>

              <g id="arrowGroup" transform="rotate(0 100 100)">
                <polygon points="100,26 82,104 118,104" fill="rgba(56,189,248,.95)"></polygon>
                <polygon points="100,26 92,52 108,52" fill="rgba(239,68,68,.92)"></polygon>
                <rect x="92" y="104" width="16" height="58" rx="8" fill="rgba(56,189,248,.55)"></rect>
              </g>
              <circle cx="100" cy="100" r="6" fill="rgba(56,189,248,.95)"></circle>
            </svg>
          </div>
          <div class="hint">
            Steer until the arrow points UP. (Uses Compass heading when available, otherwise GPS course.)
          </div>
        </div>

        <div class="mobstats">
          <div class="mobstat">
            <div class="mobk">To MOB</div>
            <div class="mobv"><span id="mobBigDist">‚Äî</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Bearing to MOB</div>
            <div class="mobv"><span id="mobBigBrg">‚Äî</span><small>¬∞</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Your heading</div>
            <div class="mobv"><span id="mobBigHdg">‚Äî</span><small>¬∞</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Turn</div>
            <div class="mobv"><span id="mobTurn">‚Äî</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Speed</div>
            <div class="mobv"><span id="mobBigSpd">‚Äî</span> <small>kn</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Accuracy</div>
            <div class="mobv"><span id="mobBigAcc">‚Äî</span> <small>m</small></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Overlay: Return to Waypoint -->
<div class="overlay" id="wpOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle">RETURN TO WAYPOINT</div>
        <div class="ovsub" id="wpHint">‚Äî</div>
      </div>
      <div class="row">
        <div class="ovbtn bad" id="btnExitWpNav">‚úï Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="mobgrid">
        <div>
          <div class="arrowbox">
            <svg class="arrowSvg" viewBox="0 0 200 200" role="img" aria-label="Steering arrow">
              <circle cx="100" cy="100" r="86" fill="none" stroke="rgba(148,163,184,.35)" stroke-width="6"></circle>
              <circle cx="100" cy="100" r="70" fill="none" stroke="rgba(148,163,184,.18)" stroke-width="4"></circle>
              <text x="100" y="26" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.85)" font-weight="800">N</text>
              <text x="178" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">E</text>
              <text x="100" y="190" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">S</text>
              <text x="22" y="106" text-anchor="middle" font-size="14" fill="rgba(148,163,184,.55)" font-weight="800">W</text>

              <g id="wpArrowGroup" transform="rotate(0 100 100)">
                <polygon points="100,26 82,104 118,104" fill="rgba(56,189,248,.95)"></polygon>
                <rect x="92" y="104" width="16" height="58" rx="8" fill="rgba(56,189,248,.55)"></rect>
              </g>
              <circle cx="100" cy="100" r="6" fill="rgba(56,189,248,.95)"></circle>
            </svg>
          </div>
          <div class="hint">Steer until the arrow points UP.</div>
        </div>

        <div class="mobstats">
          <div class="mobstat">
            <div class="mobk">To WP</div>
            <div class="mobv"><span id="wpBigDist">‚Äî</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Bearing to WP</div>
            <div class="mobv"><span id="wpBigBrg">‚Äî</span><small>¬∞</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Your heading</div>
            <div class="mobv"><span id="wpBigHdg">‚Äî</span><small>¬∞</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Turn</div>
            <div class="mobv"><span id="wpTurn">‚Äî</span></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Speed</div>
            <div class="mobv"><span id="wpBigSpd">‚Äî</span> <small>kn</small></div>
          </div>
          <div class="mobstat">
            <div class="mobk">Accuracy</div>
            <div class="mobv"><span id="wpBigAcc">‚Äî</span> <small>m</small></div>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Overlay: VHF helper -->
<div class="overlay" id="vhfOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle">VHF Distress Helper</div>
        <div class="ovsub" id="vhfSub">‚Äî</div>
      </div>
      <div class="row">
        <div class="ovbtn" id="btnVhfBig">A A</div>
        <div class="ovbtn" id="btnCopyVhf">Copy</div>
        <div class="ovbtn bad" id="btnExitVhf">‚úï Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="vhfModes">
        <div class="modePill active" data-mode="MAYDAY">MAYDAY</div>
        <div class="modePill" data-mode="PANPAN">PAN-PAN</div>
        <div class="modePill" data-mode="SECURITE">SECURIT√â</div>
      </div>

      <div class="muted">Read this slowly and clearly. Replace bracketed items with your details.</div>
      <div class="scriptBox" id="vhfScript">‚Äî</div>
      <div class="tiny">Note: DSC distress may be available on your radio. This helper supports voice procedure.</div>
    </div>
  </div>
</div>

<!-- Overlay: Fog Mode -->
<div class="overlay" id="fogOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle">FOG MODE</div>
        <div class="ovsub" id="fogSub">‚Äî</div>
      </div>
      <div class="row">
        <div class="ovbtn bad" id="btnExitFog">‚úï Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="fogScreen">
        <div class="fogRow">
          <div class="fogLabel">SPEED</div>
          <div class="fogValue"><span id="fogSpd">‚Äî</span> <small>kn</small></div>
        </div>
        <div class="fogRow">
          <div class="fogLabel">COURSE (GPS)</div>
          <div class="fogValue"><span id="fogCog">‚Äî</span><small>¬∞</small></div>
        </div>
        <div class="fogRow">
          <div class="fogLabel">HEADING (COMPASS)</div>
          <div class="fogValue"><span id="fogHdg">‚Äî</span><small>¬∞</small></div>
        </div>

        <!-- NEW: Drift -->
        <div class="fogRow">
          <div class="fogLabel">DRIFT</div>
          <div class="fogValue"><span id="fogDrift">‚Äî</span> <small>¬∞</small></div>
        </div>

        <div class="fogRow">
          <div class="fogLabel">ACCURACY</div>
          <div class="fogValue"><span id="fogAcc">‚Äî</span> <small>m</small></div>
        </div>
        <div class="tiny" style="text-align:center">
          Tip: Use Night Mode for red/dim display.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Overlay: Emergency Light -->
<div class="overlay" id="lightOverlay" aria-hidden="true">
  <div class="ovwrap">
    <div class="ovtop">
      <div>
        <div class="ovtitle">EMERGENCY LIGHT</div>
        <div class="ovsub" id="lightSub">Screen-based light (offline). Keep brightness high.</div>
      </div>
      <div class="row">
        <div class="ovbtn bad" id="btnExitLight">‚úï Exit</div>
      </div>
    </div>

    <div class="ovcard">
      <div class="lightPad">
        <div class="lightCanvas" id="lightCanvas"></div>
        <div class="lightControls">
          <div class="btn small" id="btnLightWhite">White</div>
          <div class="btn small" id="btnLightRed">Red</div>
          <div class="btn small warn" id="btnLightStrobe">Strobe</div>
          <div class="btn small primary" id="btnLightSOS">SOS</div>
          <div class="btn small bad" id="btnLightOff">Off</div>
        </div>
      </div>
      <div class="tiny" style="text-align:center">
        SOS pattern: ‚Ä¢‚Ä¢‚Ä¢ ‚Äî‚Äî‚Äî ‚Ä¢‚Ä¢‚Ä¢ (screen flashes)
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  "use strict";
  const $ = (id) => document.getElementById(id);

  const LS_KEY = "boatSafety_v1_4";
  const state = {
    watchId:null,
    lastPos:null,
    cog:null,
    spdKn:null,
    accM:null,
    compassDeg:null,
    mob:null,
    anchor:null,
    radiusM:50,
    alarmActive:false,
    settings:{ night:false, sound:true, vibe:true, log:true },
    log:[],
    floatPlan:{
      vesselName:"",
      pob:"",
      depart:"",
      dest:"",
      contact:"",
      returnTime:"",
      returnEpoch:null,
      timerRunning:false
    },
    vhfMode:"MAYDAY",
    vhfBig:false,
    waypoints:[],
    selectedWpId:null
  };

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function toRad(d){ return d*Math.PI/180; }
  function toDeg(r){ return r*180/Math.PI; }

  function load(){
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const d = JSON.parse(raw);
      if (!d || typeof d !== "object") return;
      if (d.radiusM) state.radiusM = clamp(+d.radiusM||50,10,200);
      if (d.settings) state.settings = Object.assign(state.settings, d.settings);
      if (d.mob) state.mob = d.mob;
      if (d.anchor) state.anchor = d.anchor;
      if (Array.isArray(d.log)) state.log = d.log.slice(-600);
      if (d.floatPlan) state.floatPlan = Object.assign(state.floatPlan, d.floatPlan);
      if (d.vhfMode) state.vhfMode = d.vhfMode;
      if (typeof d.vhfBig === "boolean") state.vhfBig = d.vhfBig;
      if (Array.isArray(d.waypoints)) state.waypoints = d.waypoints.slice(-1000);
      if (d.selectedWpId) state.selectedWpId = d.selectedWpId;
    }catch(_){}
  }
  function save(){
    localStorage.setItem(LS_KEY, JSON.stringify({
      radiusM: state.radiusM,
      settings: state.settings,
      mob: state.mob,
      anchor: state.anchor,
      log: state.log.slice(-600),
      floatPlan: state.floatPlan,
      vhfMode: state.vhfMode,
      vhfBig: state.vhfBig,
      waypoints: state.waypoints.slice(-1000),
      selectedWpId: state.selectedWpId
    }));
  }

  function logEvent(type, detail){
    if (!state.settings.log) return;
    const iso = new Date().toISOString();
    const pos = state.lastPos ? {lat: state.lastPos.lat, lng: state.lastPos.lng} : null;
    state.log.push({t: iso, type, detail, pos});
    if (state.log.length > 600) state.log.shift();
    save();
    renderLog();
  }

  function fmtCoord(n){ return (n==null||!isFinite(n)) ? "‚Äî" : n.toFixed(6); }
  function fmtDeg(n){ return (n==null||!isFinite(n)) ? "‚Äî" : Math.round(n).toString(); }
  function fmtKn(n){ return (n==null||!isFinite(n)) ? "‚Äî" : (Math.round(n*10)/10).toFixed(1); }
  function fmtM(n){
    if (n==null||!isFinite(n)) return "‚Äî";
    if (n<1000) return `${Math.round(n)} m`;
    return `${(n/1000).toFixed(2)} km`;
  }

  function haversineMeters(a,b){
    const R=6371000;
    const dLat=toRad(b.lat-a.lat);
    const dLon=toRad(b.lng-a.lng);
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const s=Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
    const c=2*Math.atan2(Math.sqrt(s), Math.sqrt(1-s));
    return R*c;
  }
  function bearingDeg(a,b){
    const lat1=toRad(a.lat), lat2=toRad(b.lat);
    const dLon=toRad(b.lng-a.lng);
    const y=Math.sin(dLon)*Math.cos(lat2);
    const x=Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
    return (toDeg(Math.atan2(y,x))+360)%360;
  }
  function getHeadingSource(){
    if (state.compassDeg != null && isFinite(state.compassDeg)) return {val: state.compassDeg, src:"compass"};
    if (state.cog != null && isFinite(state.cog)) return {val: state.cog, src:"gps"};
    return {val:null, src:"none"};
  }
  function deltaAngle(target, current){
    if (target==null || current==null) return null;
    return (target - current + 540) % 360 - 180;
  }

  // =========================
  // NEW: Drift Advisor (Set & Drift)
  // =========================
  function driftInfo(){
    const hdg = state.compassDeg;
    const cog = state.cog;
    const spd = state.spdKn;
    const acc = state.accM;

    if (hdg == null || !isFinite(hdg) || cog == null || !isFinite(cog)) {
      return { ok:false, msg:"Enable Compass + Start GPS", drift:null };
    }
    // Reliability guards
    if (spd == null || spd < 1.0) {
      return { ok:false, msg:"Increase speed for reliable course", drift:null };
    }
    if (acc != null && acc > 30) {
      return { ok:false, msg:"GPS accuracy low ‚Äî wait for better fix", drift:null };
    }

    // drift = where COG is vs heading (positive => COG right of heading)
    const drift = deltaAngle(cog, hdg); // [-180..+180]
    const abs = Math.round(Math.abs(drift));

    if (abs < 5) {
      return { ok:true, drift, label:"‚âà 0¬∞", advisor:"ON COURSE", side:"NONE" };
    }

    const side = (drift > 0) ? "RIGHT" : "LEFT";
    const steer = (drift > 0) ? "LEFT" : "RIGHT";

    return {
      ok:true,
      drift,
      label: `${side} ${abs}¬∞`,
      advisor: `Steer ${steer} ~${abs}¬∞ (to reduce drift)`,
      side
    };
  }

  function updateDriftUI(){
    const out = driftInfo();
    const dv = $("driftVal");
    const dr = $("driftRec");
    const fd = $("fogDrift");
    if (!dv || !dr) return;

    if (!out.ok){
      dv.textContent = "‚Äî";
      dr.textContent = out.msg || "‚Äî";
      if (fd) fd.textContent = "‚Äî";
      return;
    }

    dv.textContent = out.label;
    dr.textContent = out.advisor;
    if (fd) fd.textContent = String(Math.round(Math.abs(out.drift)));
  }

  // Alarm (sound + vibration)
  let audioCtx=null, alarmTimer=null;
  function beepOnce(){
    try{
      if (!state.settings.sound) return;
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator();
      const g=audioCtx.createGain();
      o.type="sine"; o.frequency.value=880;
      g.gain.value=0.0001;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      const now=audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.12, now+0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now+0.25);
      o.stop(now+0.26);
    }catch(_){}
  }
  function vibratePattern(){
    if (!state.settings.vibe) return;
    if (navigator.vibrate) navigator.vibrate([200,120,200,120,350]);
  }
  function startAlarm(reason){
    if (state.alarmActive) return;
    state.alarmActive=true;
    save();
    setFooterStatus("bad");
    $("alarmState").textContent = "Alarm ON";
    logEvent("ALARM", reason || "Alarm triggered");
    beepOnce(); vibratePattern();
    alarmTimer = setInterval(()=>{beepOnce(); vibratePattern();}, 1800);
  }
  function stopAlarm(){
    state.alarmActive=false;
    if (alarmTimer) clearInterval(alarmTimer);
    alarmTimer=null;
    save();
    updateOverallStatus();
    $("alarmState").textContent = "Alarm OFF";
  }

  // Footer status
  function setFooterStatus(level){
    const dot = $("dot");
    dot.classList.remove("good","warn","bad");
    if (level) dot.classList.add(level);
    if (level==="good") $("footerStatus").textContent = "All systems normal";
    if (level==="warn") $("footerStatus").textContent = "Attention needed";
    if (level==="bad")  $("footerStatus").textContent = "ALARM active";
  }
  function updateOverallStatus(){
    if (state.alarmActive) return setFooterStatus("bad");
    if (state.watchId!=null && state.lastPos) return setFooterStatus("good");
    return setFooterStatus("warn");
  }

  // GPS
  function startGPS(){
    if (!navigator.geolocation){
      $("gpsState").textContent = "GPS unavailable";
      setFooterStatus("warn");
      return;
    }
    if (state.watchId != null) return;

    $("gpsState").textContent = "Waiting for GPS‚Ä¶";
    setFooterStatus("warn");

    state.watchId = navigator.geolocation.watchPosition(
      (pos)=>{
        const c=pos.coords;
        state.lastPos={lat:c.latitude, lng:c.longitude};
        state.accM=c.accuracy;
        state.spdKn=(c.speed==null||!isFinite(c.speed))?null:(c.speed*1.94384449);
        state.cog=(c.heading==null||!isFinite(c.heading))?null:c.heading;

        renderFix(pos.timestamp);
        updateMOB();
        updateAnchor();
        updateMOBOverlay();
        updateWpPanel();
        updateWpOverlay();
        updateVhfOverlay();
        updateFogOverlay();
        updateFloatCountdown();
        updateDriftUI();         // NEW
        updateOverallStatus();
      },
      (err)=>{
        $("gpsState").textContent = (err && err.code===1) ? "GPS permission denied" : "GPS unavailable";
        setFooterStatus("warn");
      },
      {enableHighAccuracy:true, maximumAge:1000, timeout:15000}
    );

    $("gpsState").textContent = "GPS running";
    logEvent("GPS","Started");
  }
  function stopGPS(){
    if (state.watchId != null){
      navigator.geolocation.clearWatch(state.watchId);
      state.watchId=null;
      $("gpsState").textContent="GPS stopped";
      logEvent("GPS","Stopped");
      updateOverallStatus();
      updateFogOverlay();
      updateFloatCountdown();
      updateDriftUI(); // NEW
    }
  }
  function renderFix(ts){
    $("lat").textContent = fmtCoord(state.lastPos?.lat);
    $("lng").textContent = fmtCoord(state.lastPos?.lng);
    $("acc").textContent = (state.accM==null) ? "‚Äî" : Math.round(state.accM).toString();
    $("spd").textContent = fmtKn(state.spdKn);
    $("cog").textContent = fmtDeg(state.cog);
    $("hdg").textContent = fmtDeg(state.compassDeg);
    $("fixTime").textContent = new Date(ts).toLocaleString();

    $("mobBigSpd").textContent = fmtKn(state.spdKn);
    $("mobBigAcc").textContent = (state.accM==null) ? "‚Äî" : Math.round(state.accM).toString();

    $("wpBigSpd").textContent = fmtKn(state.spdKn);
    $("wpBigAcc").textContent = (state.accM==null) ? "‚Äî" : Math.round(state.accM).toString();
  }

  // Compass banner
  let compSeen=false, compWaitTimer=null;
  function setCompBanner(level, msg){
    const dot = $("compDot");
    dot.classList.remove("good","warn","bad");
    if (level) dot.classList.add(level);
    $("compTitle").textContent = "Compass";
    $("compMsg").textContent = msg;
  }
  function handleOrientation(ev){
    let heading=null;
    if (typeof ev.webkitCompassHeading === "number" && isFinite(ev.webkitCompassHeading)) heading = ev.webkitCompassHeading;
    else if (typeof ev.alpha === "number" && isFinite(ev.alpha)) heading = (360 - ev.alpha) % 360;

    if (heading != null){
      state.compassDeg = heading;
      $("hdg").textContent = fmtDeg(state.compassDeg);
      compSeen = true;
      setCompBanner("good", "Compass enabled ‚Äî heading updating");
      updateMOBOverlay();
      updateWpOverlay();
      updateFogOverlay();
      updateDriftUI(); // NEW
      save();
    }
  }
  async function enableCompass(){
    compSeen = false;
    setCompBanner("warn", "Compass enabled ‚Äî waiting for heading‚Ä¶");

    if (!("DeviceOrientationEvent" in window)){
      setCompBanner("warn", "Compass not supported on this device/browser");
      logEvent("COMPASS","Unavailable");
      return;
    }
    try{
      if (typeof DeviceOrientationEvent.requestPermission === "function"){
        const res = await DeviceOrientationEvent.requestPermission();
        if (res !== "granted") throw new Error("denied");
      }
      window.addEventListener("deviceorientation", handleOrientation, true);
      logEvent("COMPASS","Enabled");
      if (compWaitTimer) clearTimeout(compWaitTimer);
      compWaitTimer = setTimeout(()=>{
        if (!compSeen){
          setCompBanner("warn", "Compass enabled ‚Äî waiting for heading‚Ä¶");
        }
      }, 3000);
    }catch(_){
      setCompBanner("warn", "Compass permission denied (or not available)");
      logEvent("COMPASS","Denied");
    }
  }

  // Night mode
  function setNight(on){
    state.settings.night = !!on;
    document.body.classList.toggle("night", state.settings.night);
    const meta=document.querySelector('meta[name="theme-color"]');
    if (meta) meta.setAttribute("content", state.settings.night ? "#05060a" : "#0b3d91");
    save();
  }

  // README
  function toggleReadme(){ $("readmeBox").classList.toggle("show"); }

  // MOB
  function setMOB(){
    if (!state.lastPos) return;
    state.mob={...state.lastPos, t:Date.now()};
    save();
    renderMOB();
    logEvent("MOB", `${state.mob.lat.toFixed(6)}, ${state.mob.lng.toFixed(6)}`);
  }
  function clearMOB(){
    state.mob=null;
    save();
    renderMOB();
    logEvent("MOB","Cleared");
    hideMOBOverlay();
  }
  function renderMOB(){
    if (!state.mob){
      $("mobPoint").textContent="‚Äî";
      $("mobDist").textContent="‚Äî";
      $("mobBrg").textContent="‚Äî";
      return;
    }
    $("mobPoint").textContent = `${state.mob.lat.toFixed(6)}, ${state.mob.lng.toFixed(6)}`;
    updateMOB();
  }
  function updateMOB(){
    if (!state.mob || !state.lastPos) return;
    const d=haversineMeters(state.lastPos, state.mob);
    const b=bearingDeg(state.lastPos, state.mob);
    $("mobDist").textContent = fmtM(d);
    $("mobBrg").textContent = `${Math.round(b)}¬∞`;
  }

  // Anchor
  function setAnchor(){
    if (!state.lastPos) return;
    state.anchor={...state.lastPos, t:Date.now()};
    save();
    renderAnchor();
    logEvent("ANCHOR", `${state.anchor.lat.toFixed(6)}, ${state.anchor.lng.toFixed(6)} (r=${state.radiusM}m)`);
  }
  function clearAnchor(){
    state.anchor=null;
    save();
    renderAnchor();
    stopAlarm();
    logEvent("ANCHOR","Cleared");
  }
  function renderAnchor(){
    if (!state.anchor){
      $("anchorPoint").textContent="‚Äî";
      $("anchorDist").textContent="‚Äî";
      $("anchorStatus").textContent="‚Äî";
      return;
    }
    $("anchorPoint").textContent=`${state.anchor.lat.toFixed(6)}, ${state.anchor.lng.toFixed(6)}`;
    updateAnchor();
  }
  function updateAnchor(){
    if (!state.anchor || !state.lastPos) return;
    const d=haversineMeters(state.lastPos, state.anchor);
    $("anchorDist").textContent = fmtM(d);
    const ok = d <= state.radiusM;
    $("anchorStatus").textContent = ok ? "OK" : "ALARM";
    if (!ok) startAlarm("Anchor radius exceeded");
    if (ok && state.alarmActive) stopAlarm();
  }

  // Overlays - wake lock best effort
  let wakeLock=null;
  async function requestWakeLock(){
    try{ if ("wakeLock" in navigator && !wakeLock) wakeLock = await navigator.wakeLock.request("screen"); }catch(_){}
  }
  async function releaseWakeLock(){
    try{ if (wakeLock){ await wakeLock.release(); wakeLock=null; } }catch(_){}
  }

  // Return to MOB overlay
  let mobOverlayTimer=null;
  function showMOBOverlay(){
    if (!state.mob){ alert("Mark MOB first (press MOB)."); return; }
    $("mobOverlay").classList.add("show");
    updateMOBOverlay();
    mobOverlayTimer = mobOverlayTimer || setInterval(updateMOBOverlay, 400);
    requestWakeLock();
  }
  function hideMOBOverlay(){
    $("mobOverlay").classList.remove("show");
    if (mobOverlayTimer) clearInterval(mobOverlayTimer);
    mobOverlayTimer=null;
    releaseWakeLock();
  }
  function updateMOBOverlay(){
    const hintBits=[];
    if (!state.mob) hintBits.push("Mark MOB first.");
    if (state.watchId==null) hintBits.push("Start GPS for live updates.");
    const hs=getHeadingSource();
    if (hs.src==="gps") hintBits.push("Compass recommended for best steering.");
    $("mobHint").textContent = hintBits.length ? hintBits.join(" ‚Ä¢ ") : "‚Äî";

    if (!state.mob || !state.lastPos){
      $("mobBigDist").textContent="‚Äî";
      $("mobBigBrg").textContent="‚Äî";
      $("mobBigHdg").textContent="‚Äî";
      $("mobTurn").textContent="‚Äî";
      return;
    }
    const d=haversineMeters(state.lastPos, state.mob);
    const b=bearingDeg(state.lastPos, state.mob);
    $("mobBigDist").textContent=fmtM(d);
    $("mobBigBrg").textContent=Math.round(b).toString();

    const heading=hs.val;
    $("mobBigHdg").textContent = heading==null ? "‚Äî" : Math.round(heading).toString();

    const rel = (heading==null) ? 0 : ((b - heading + 360) % 360);
    $("arrowGroup").setAttribute("transform", `rotate(${rel.toFixed(1)} 100 100)`);

    const delta = deltaAngle(b, heading);
    if (delta==null) $("mobTurn").textContent="‚Äî";
    else{
      const abs=Math.abs(delta);
      if (abs < 8) $("mobTurn").textContent = "ON COURSE";
      else if (delta < 0) $("mobTurn").textContent = `LEFT ${Math.round(abs)}¬∞`;
      else $("mobTurn").textContent = `RIGHT ${Math.round(abs)}¬∞`;
    }
  }

  // VHF helper
  function showVhf(){
    $("vhfOverlay").classList.add("show");
    updateVhfOverlay();
    requestWakeLock();
  }
  function hideVhf(){
    $("vhfOverlay").classList.remove("show");
    releaseWakeLock();
  }
  function fmtPosLine(){
    if (!state.lastPos) return "[POSITION: unknown]";
    return `POSITION: ${state.lastPos.lat.toFixed(6)}, ${state.lastPos.lng.toFixed(6)} (WGS84)`;
  }
  function buildVhfScript(){
    const vessel = state.floatPlan.vesselName || "[VESSEL NAME]";
    const pob = state.floatPlan.pob || "[PEOPLE ON BOARD]";
    const contact = state.floatPlan.contact || "[SHORE CONTACT]";
    const posLine = fmtPosLine();
    const timeLine = `TIME: ${new Date().toISOString()}`;
    const distress = "[NATURE OF DISTRESS / ASSISTANCE REQUIRED]";
    const desc = "[DESCRIPTION: type/size/colour, etc.]";

    if (state.vhfMode === "MAYDAY"){
      return [
        "MAYDAY MAYDAY MAYDAY",
        `THIS IS ${vessel}, ${vessel}, ${vessel}`,
        posLine, timeLine,
        `WE HAVE ${distress}`,
        `PEOPLE ON BOARD: ${pob}`,
        `OTHER INFO: ${desc}`,
        "REQUEST IMMEDIATE ASSISTANCE",
        "OVER"
      ].join("\n");
    }
    if (state.vhfMode === "PANPAN"){
      return [
        "PAN-PAN PAN-PAN PAN-PAN",
        "ALL STATIONS ALL STATIONS ALL STATIONS",
        `THIS IS ${vessel}, ${vessel}, ${vessel}`,
        posLine, timeLine,
        `WE HAVE ${distress}`,
        `PEOPLE ON BOARD: ${pob}`,
        `SHORE CONTACT: ${contact}`,
        "REQUEST ASSISTANCE / ADVICE",
        "OVER"
      ].join("\n");
    }
    return [
      "SECURIT√â SECURIT√â SECURIT√â",
      "ALL STATIONS ALL STATIONS ALL STATIONS",
      `THIS IS ${vessel}, ${vessel}, ${vessel}`,
      posLine, timeLine,
      "NAVIGATIONAL / WEATHER WARNING:",
      "[HAZARD DETAILS / AREA / RECOMMENDATION]",
      "OUT"
    ].join("\n");
  }
  function updateVhfOverlay(){
    $("vhfSub").textContent = state.lastPos ? `${state.lastPos.lat.toFixed(5)}, ${state.lastPos.lng.toFixed(5)}` : "‚Äî";
    const box = $("vhfScript");
    box.textContent = buildVhfScript();
    box.classList.toggle("big", !!state.vhfBig);
  }
  async function copyText(text){
    try{ await navigator.clipboard.writeText(text); alert("Copied to clipboard"); }
    catch(_){ alert("Could not copy (browser blocked it)."); }
  }

  // Fog Mode
  let fogTimer=null;
  function showFog(){
    $("fogOverlay").classList.add("show");
    updateFogOverlay();
    fogTimer = fogTimer || setInterval(updateFogOverlay, 500);
    requestWakeLock();
  }
  function hideFog(){
    $("fogOverlay").classList.remove("show");
    if (fogTimer) clearInterval(fogTimer);
    fogTimer=null;
    releaseWakeLock();
  }
  function updateFogOverlay(){
    $("fogSub").textContent = state.lastPos ? `${state.lastPos.lat.toFixed(5)}, ${state.lastPos.lng.toFixed(5)}` : "Start GPS for live values";
    $("fogSpd").textContent = fmtKn(state.spdKn);
    $("fogCog").textContent = fmtDeg(state.cog);
    $("fogHdg").textContent = fmtDeg(state.compassDeg);
    $("fogAcc").textContent = (state.accM==null) ? "‚Äî" : Math.round(state.accM).toString();
    updateDriftUI(); // NEW
  }

  // Emergency Light (screen-based)
  let lightMode="OFF";
  let lightTimer=null;
  let sosTimer=null;
  const lightCanvas = () => $("lightCanvas");

  function setLight(color){ lightCanvas().style.background = color; }
  function stopLightTimers(){
    if (lightTimer) clearInterval(lightTimer);
    lightTimer=null;
    if (sosTimer) { clearTimeout(sosTimer); sosTimer=null; }
  }
  function lightOff(){ stopLightTimers(); lightMode="OFF"; setLight("#000"); logEvent("LIGHT","Off"); }
  function lightWhite(){ stopLightTimers(); lightMode="WHITE"; setLight("#fff"); logEvent("LIGHT","White"); }
  function lightRed(){ stopLightTimers(); lightMode="RED"; setLight("#b00000"); logEvent("LIGHT","Red"); }
  function lightStrobe(){
    stopLightTimers(); lightMode="STROBE";
    let on=false;
    lightTimer = setInterval(()=>{ on=!on; setLight(on ? "#fff" : "#000"); }, 160);
    logEvent("LIGHT","Strobe");
  }
  function lightSOS(){
    stopLightTimers(); lightMode="SOS";
    const DOT=200, DASH=600, INTRA=200, LGAP=600, WGAP=1400;
    const seq = [
      {on:true,  ms:DOT},{on:false, ms:INTRA},
      {on:true,  ms:DOT},{on:false, ms:INTRA},
      {on:true,  ms:DOT},{on:false, ms:LGAP},
      {on:true,  ms:DASH},{on:false, ms:INTRA},
      {on:true,  ms:DASH},{on:false, ms:INTRA},
      {on:true,  ms:DASH},{on:false, ms:LGAP},
      {on:true,  ms:DOT},{on:false, ms:INTRA},
      {on:true,  ms:DOT},{on:false, ms:INTRA},
      {on:true,  ms:DOT},{on:false, ms:WGAP}
    ];
    let i=0;
    const step=()=>{
      const s = seq[i];
      setLight(s.on ? "#fff" : "#000");
      i = (i+1) % seq.length;
      sosTimer = setTimeout(step, s.ms);
    };
    step();
    logEvent("LIGHT","SOS");
  }

  function showLight(){ $("lightOverlay").classList.add("show"); requestWakeLock(); if (lightMode==="OFF") setLight("#000"); }
  function hideLight(){ $("lightOverlay").classList.remove("show"); releaseWakeLock(); }

  // Float plan
  let floatTimer = null;
  function applyFloatToUI(){
    $("vesselName").value = state.floatPlan.vesselName || "";
    $("pob").value = state.floatPlan.pob || "";
    $("depart").value = state.floatPlan.depart || "";
    $("dest").value = state.floatPlan.dest || "";
    $("contact").value = state.floatPlan.contact || "";
    $("returnTime").value = state.floatPlan.returnTime || "";
  }
  function readFloatFromUI(){
    state.floatPlan.vesselName = ($("vesselName").value || "").trim();
    state.floatPlan.pob = ($("pob").value || "").trim();
    state.floatPlan.depart = ($("depart").value || "").trim();
    state.floatPlan.dest = ($("dest").value || "").trim();
    state.floatPlan.contact = ($("contact").value || "").trim();
    state.floatPlan.returnTime = ($("returnTime").value || "").trim();
  }
  function computeReturnEpochToday(hhmm){
    if (!hhmm || !/^\d\d:\d\d$/.test(hhmm)) return null;
    const [hh, mm] = hhmm.split(":").map(n=>+n);
    const now = new Date();
    return new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0).getTime();
  }
  function startFloatTimer(){
    readFloatFromUI();
    const epoch = computeReturnEpochToday(state.floatPlan.returnTime);
    if (!epoch){ alert("Please choose a return time."); return; }
    state.floatPlan.returnEpoch = epoch;
    state.floatPlan.timerRunning = true;
    save();
    $("floatStatus").textContent = "Timer running";
    logEvent("FLOAT","Timer started");
    updateFloatCountdown(true);
    floatTimer = floatTimer || setInterval(updateFloatCountdown, 1000);
  }
  function stopFloatTimer(){
    state.floatPlan.timerRunning = false;
    save();
    $("floatStatus").textContent = "Timer stopped";
    logEvent("FLOAT","Timer stopped");
    if (floatTimer) clearInterval(floatTimer);
    floatTimer = null;
    updateFloatCountdown(true);
  }
  function updateFloatCountdown(force){
    const running = !!state.floatPlan.timerRunning;
    const epoch = state.floatPlan.returnEpoch;
    if (!running || !epoch){
      $("countdown").textContent = "‚Äî";
      if (force) $("floatStatus").textContent = "‚Äî";
      return;
    }
    const now = Date.now();
    let diff = epoch - now;
    const overdue = diff < 0;
    diff = Math.abs(diff);

    const s = Math.floor(diff/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    const text = `${String(hh).padStart(2,"0")}:${String(mm).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    $("countdown").textContent = overdue ? `OVERDUE ${text}` : text;
    $("floatStatus").textContent = overdue ? "OVERDUE" : "Timer running";

    if (overdue && !state.alarmActive){
      startAlarm("Float plan overdue");
      logEvent("FLOAT","Overdue alarm");
    }
  }
  function saveFloat(){ readFloatFromUI(); save(); $("floatStatus").textContent = "Plan saved"; logEvent("FLOAT","Plan saved"); }
  function clearFloat(){
    state.floatPlan = {vesselName:"",pob:"",depart:"",dest:"",contact:"",returnTime:"",returnEpoch:null,timerRunning:false};
    save(); applyFloatToUI(); stopFloatTimer(); $("floatStatus").textContent = "‚Äî"; logEvent("FLOAT","Plan cleared");
  }
  function buildFloatMessage(){
    readFloatFromUI();
    const lines = [];
    lines.push("FLOAT PLAN");
    lines.push(`Vessel: ${state.floatPlan.vesselName || "[Vessel]"}`);
    lines.push(`People on board: ${state.floatPlan.pob || "[POB]"}`);
    lines.push(`Departure: ${state.floatPlan.depart || "[Departure]"}`);
    lines.push(`Destination: ${state.floatPlan.dest || "[Destination]"}`);
    lines.push(`Return time: ${state.floatPlan.returnTime || "[HH:MM]"}`);
    lines.push(`Shore contact: ${state.floatPlan.contact || "[Contact]"}`);
    lines.push(state.lastPos ? `Last known position: ${state.lastPos.lat.toFixed(6)}, ${state.lastPos.lng.toFixed(6)}` : "Last known position: [unknown]");
    lines.push(`Generated: ${new Date().toISOString()}`);
    lines.push("¬© 2026 Glen Carruthers. All rights reserved.");
    return lines.join("\n");
  }

  // Waypoints
  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function markWaypoint(type){
    if (!state.lastPos){ alert("Start GPS first."); return; }
    const wp = { id: uid(), type, lat: state.lastPos.lat, lng: state.lastPos.lng, t: Date.now(), notes: "" };
    state.waypoints.unshift(wp);
    state.selectedWpId = wp.id;
    save();
    renderWpSelect();
    updateWpPanel();
    logEvent("WAYPOINT", `${type} ${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}`);
  }

  function renderWpSelect(){
    const sel = $("wpSelect");
    sel.innerHTML = "";
    const wps = state.waypoints;
    $("wpCount").textContent = String(wps.length);

    if (!wps.length){
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "(no waypoints)";
      sel.appendChild(opt);
      return;
    }

    for (const wp of wps){
      const opt = document.createElement("option");
      opt.value = wp.id;
      const dt = new Date(wp.t);
      opt.textContent = `${wp.type} ‚Ä¢ ${dt.toLocaleString()} ‚Ä¢ ${wp.lat.toFixed(4)},${wp.lng.toFixed(4)}`;
      sel.appendChild(opt);
    }

    sel.value = state.selectedWpId || wps[0].id;
    if (!state.selectedWpId) state.selectedWpId = sel.value;
  }

  function getSelectedWp(){
    if (!state.selectedWpId) return null;
    return state.waypoints.find(w=>w.id===state.selectedWpId) || null;
  }

  function updateWpPanel(){
    const wp = getSelectedWp();
    if (!wp){
      $("wpType").textContent = "‚Äî";
      $("wpCoords").textContent = "‚Äî";
      $("wpDist").textContent = "‚Äî";
      $("wpBrg").textContent = "‚Äî";
      $("wpNotes").value = "";
      return;
    }
    $("wpType").textContent = wp.type;
    $("wpCoords").textContent = `${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}`;
    $("wpNotes").value = wp.notes || "";

    if (state.lastPos){
      const d = haversineMeters(state.lastPos, wp);
      const b = bearingDeg(state.lastPos, wp);
      $("wpDist").textContent = fmtM(d);
      $("wpBrg").textContent = `${Math.round(b)}¬∞`;
    } else {
      $("wpDist").textContent = "‚Äî";
      $("wpBrg").textContent = "‚Äî";
    }
  }

  function saveWpNotes(){
    const wp = getSelectedWp();
    if (!wp) return;
    wp.notes = ($("wpNotes").value || "").trim();
    save();
    logEvent("WAYPOINT","Notes saved");
  }

  function deleteWp(){
    const wp = getSelectedWp();
    if (!wp) return;
    const ok = confirm("Delete this waypoint?");
    if (!ok) return;
    state.waypoints = state.waypoints.filter(w=>w.id!==wp.id);
    state.selectedWpId = state.waypoints[0]?.id || null;
    save();
    renderWpSelect();
    updateWpPanel();
    logEvent("WAYPOINT","Deleted");
  }

  function exportWaypointsCSV(){
    if (!state.waypoints.length) return;
    const rows=[["id","type","time_iso","lat","lng","notes"]];
    for (const w of state.waypoints){
      rows.push([w.id, w.type, new Date(w.t).toISOString(), w.lat, w.lng, (w.notes||"").replaceAll('"','""')]);
    }
    const csv=rows.map(r=>r.map(v=>`"${String(v)}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`boat-safety-waypoints-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // Return-to-WP overlay (steering arrow)
  let wpNavTimer=null;
  function showWpOverlay(){
    const wp = getSelectedWp();
    if (!wp){ alert("No waypoint selected."); return; }
    $("wpOverlay").classList.add("show");
    updateWpOverlay();
    wpNavTimer = wpNavTimer || setInterval(updateWpOverlay, 400);
    requestWakeLock();
  }
  function hideWpOverlay(){
    $("wpOverlay").classList.remove("show");
    if (wpNavTimer) clearInterval(wpNavTimer);
    wpNavTimer=null;
    releaseWakeLock();
  }
  function updateWpOverlay(){
    const wp = getSelectedWp();
    const hintBits=[];
    if (!wp) hintBits.push("Select a waypoint.");
    if (state.watchId==null) hintBits.push("Start GPS for live updates.");
    const hs=getHeadingSource();
    if (hs.src==="gps") hintBits.push("Compass recommended for best steering.");
    $("wpHint").textContent = hintBits.length ? hintBits.join(" ‚Ä¢ ") : "‚Äî";

    if (!wp || !state.lastPos){
      $("wpBigDist").textContent="‚Äî";
      $("wpBigBrg").textContent="‚Äî";
      $("wpBigHdg").textContent="‚Äî";
      $("wpTurn").textContent="‚Äî";
      return;
    }
    const d=haversineMeters(state.lastPos, wp);
    const b=bearingDeg(state.lastPos, wp);
    $("wpBigDist").textContent=fmtM(d);
    $("wpBigBrg").textContent=Math.round(b).toString();

    const heading=hs.val;
    $("wpBigHdg").textContent = heading==null ? "‚Äî" : Math.round(heading).toString();

    const rel = (heading==null) ? 0 : ((b - heading + 360) % 360);
    $("wpArrowGroup").setAttribute("transform", `rotate(${rel.toFixed(1)} 100 100)`);

    const delta = deltaAngle(b, heading);
    if (delta==null) $("wpTurn").textContent="‚Äî";
    else{
      const abs=Math.abs(delta);
      if (abs < 8) $("wpTurn").textContent = "ON COURSE";
      else if (delta < 0) $("wpTurn").textContent = `LEFT ${Math.round(abs)}¬∞`;
      else $("wpTurn").textContent = `RIGHT ${Math.round(abs)}¬∞`;
    }
  }

  // Log UI
  function renderLog(){
    if (!state.log.length){ $("logBox").textContent="‚Äî"; return; }
    $("logBox").textContent = state.log.slice().reverse().map(e=>{
      const p = e.pos ? ` @${e.pos.lat.toFixed(5)},${e.pos.lng.toFixed(5)}` : "";
      return `${e.t} | ${e.type} | ${e.detail}${p}`;
    }).join("\n");
  }
  function exportLogCSV(){
    if (!state.log.length) return;
    const rows=[["time_iso","type","detail","lat","lng"]];
    for (const e of state.log){
      rows.push([e.t, e.type, (e.detail||"").replaceAll('"','""'), e.pos?.lat??"", e.pos?.lng??""]);
    }
    const csv=rows.map(r=>r.map(v=>`"${String(v)}"`).join(",")).join("\n");
    const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a");
    a.href=url;
    a.download=`boat-safety-log-${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  // Wire events
  function wire(){
    $("btnStartGPS").addEventListener("click", startGPS);
    $("btnStopGPS").addEventListener("click", stopGPS);
    $("btnCompass").addEventListener("click", enableCompass);

    $("btnReadme").addEventListener("click", toggleReadme);

    $("btnNight").addEventListener("click", ()=>{ $("setNight").checked = !$("setNight").checked; setNight($("setNight").checked); });
    $("setNight").addEventListener("change", (e)=> setNight(!!e.target.checked));
    $("setSound").addEventListener("change",(e)=>{ state.settings.sound=!!e.target.checked; save(); });
    $("setVibe").addEventListener("change",(e)=>{ state.settings.vibe=!!e.target.checked; save(); });
    $("setLog").addEventListener("change",(e)=>{ state.settings.log=!!e.target.checked; save(); renderLog(); });

    $("btnMOB").addEventListener("click", ()=>{
      if (!state.lastPos) return;
      setMOB();
      beepOnce(); if (navigator.vibrate) navigator.vibrate([120,80,120]);
    });
    $("btnClearMOB").addEventListener("click", clearMOB);
    $("btnReturnMOB").addEventListener("click", showMOBOverlay);
    $("btnExitMob").addEventListener("click", hideMOBOverlay);
    $("mobOverlay").addEventListener("click", (e)=>{ if (e.target && e.target.id==="mobOverlay") hideMOBOverlay(); });
    $("btnCalibrate").addEventListener("click", ()=> alert("To calibrate: move the phone in a figure-8 away from metal, then hold it flat."));

    $("btnAnchorSet").addEventListener("click", ()=>{ if (state.lastPos) setAnchor(); });
    $("btnAnchorClear").addEventListener("click", clearAnchor);
    $("rad").addEventListener("input", (e)=>{
      state.radiusM = clamp(+e.target.value,10,200);
      $("radVal").textContent = state.radiusM;
      save();
      if (state.anchor && state.lastPos) updateAnchor();
    });

    $("btnStopAlarm").addEventListener("click", stopAlarm);
    $("btnTestAlarm").addEventListener("click", ()=>{ beepOnce(); vibratePattern(); logEvent("TEST","Alarm test"); });

    $("btnExport").addEventListener("click", exportLogCSV);
    $("btnClearLog").addEventListener("click", ()=>{ state.log=[]; save(); renderLog(); });

    // VHF
    $("btnVHF").addEventListener("click", showVhf);
    $("btnExitVhf").addEventListener("click", hideVhf);
    $("vhfOverlay").addEventListener("click",(e)=>{ if (e.target && e.target.id==="vhfOverlay") hideVhf(); });
    document.querySelectorAll(".modePill").forEach(el=>{
      el.addEventListener("click", ()=>{
        state.vhfMode = el.dataset.mode;
        save();
        document.querySelectorAll(".modePill").forEach(p=>p.classList.toggle("active", p.dataset.mode===state.vhfMode));
        updateVhfOverlay();
      });
    });
    $("btnVhfBig").addEventListener("click", ()=>{
      state.vhfBig = !state.vhfBig;
      save();
      updateVhfOverlay();
    });
    $("btnCopyVhf").addEventListener("click", ()=> copyText(buildVhfScript()));

    // Fog + Light
    $("btnFog").addEventListener("click", showFog);
    $("btnExitFog").addEventListener("click", hideFog);
    $("fogOverlay").addEventListener("click",(e)=>{ if (e.target && e.target.id==="fogOverlay") hideFog(); });

    $("btnLight").addEventListener("click", showLight);
    $("btnExitLight").addEventListener("click", hideLight);
    $("lightOverlay").addEventListener("click",(e)=>{ if (e.target && e.target.id==="lightOverlay") hideLight(); });

    $("btnLightWhite").addEventListener("click", lightWhite);
    $("btnLightRed").addEventListener("click", lightRed);
    $("btnLightStrobe").addEventListener("click", lightStrobe);
    $("btnLightSOS").addEventListener("click", lightSOS);
    $("btnLightOff").addEventListener("click", lightOff);

    // Float plan
    $("btnSaveFloat").addEventListener("click", saveFloat);
    $("btnStartTimer").addEventListener("click", startFloatTimer);
    $("btnStopTimer").addEventListener("click", stopFloatTimer);
    $("btnClearFloat").addEventListener("click", clearFloat);
    $("btnCopyFloat").addEventListener("click", ()=> copyText(buildFloatMessage()));

    // Waypoints
    $("btnMarkHazard").addEventListener("click", ()=> markWaypoint("HAZARD"));
    $("btnMarkHarbor").addEventListener("click", ()=> markWaypoint("SAFE_HARBOR"));
    $("btnMarkWP").addEventListener("click", ()=> markWaypoint("WAYPOINT"));
    $("wpSelect").addEventListener("change", (e)=>{
      state.selectedWpId = e.target.value || null;
      save();
      updateWpPanel();
    });
    $("btnSaveWpNotes").addEventListener("click", saveWpNotes);
    $("btnDeleteWP").addEventListener("click", deleteWp);
    $("btnExportWP").addEventListener("click", exportWaypointsCSV);
    $("btnReturnWP").addEventListener("click", showWpOverlay);
    $("btnExitWpNav").addEventListener("click", hideWpOverlay);
    $("wpOverlay").addEventListener("click",(e)=>{ if (e.target && e.target.id==="wpOverlay") hideWpOverlay(); });

    // Esc closes overlays
    window.addEventListener("keydown",(e)=>{
      if (e.key==="Escape"){
        hideMOBOverlay(); hideVhf(); hideFog(); hideLight(); hideWpOverlay();
      }
    });
  }

  // Init
  load();
  document.body.classList.toggle("night", !!state.settings.night);
  $("setNight").checked = !!state.settings.night;
  $("setSound").checked = !!state.settings.sound;
  $("setVibe").checked = !!state.settings.vibe;
  $("setLog").checked = !!state.settings.log;

  $("rad").value = state.radiusM;
  $("radVal").textContent = state.radiusM;

  $("yy").textContent = new Date().getFullYear();

  applyFloatToUI();
  renderLog();
  renderMOB();
  renderAnchor();

  renderWpSelect();
  updateWpPanel();

  $("alarmState").textContent = "Alarm OFF";
  $("gpsState").textContent = "GPS stopped";
  setCompBanner("warn", "Tap Enable Compass to use the phone heading sensor.");

  // Restore float timer
  if (state.floatPlan.timerRunning && state.floatPlan.returnEpoch){
    $("floatStatus").textContent = "Timer running";
    floatTimer = setInterval(updateFloatCountdown, 1000);
    updateFloatCountdown(true);
  } else {
    $("floatStatus").textContent = "‚Äî";
  }

  // Restore VHF mode UI
  document.querySelectorAll(".modePill").forEach(p=>p.classList.toggle("active", p.dataset.mode===state.vhfMode));

  wire();
  updateOverallStatus();
  updateDriftUI(); // NEW

  // SW
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
  }

  // Install prompt
  let deferredPrompt = null;
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    $("btnInstall").style.display = "inline-block";
  });
  $("btnInstall").addEventListener("click", async () => {
    try{
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      $("btnInstall").style.display = "none";
    }catch(_){}
  });

})();
</script>
</body>
</html>